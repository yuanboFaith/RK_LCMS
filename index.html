<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Analysis of Raspberry Ketone Metabolites Using UHPLC-QqQ-MS/MS in Mice Plasma and Brain</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">LC/MS method development & validation</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">R script</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Analysis of Raspberry Ketone Metabolites Using UHPLC-QqQ-MS/MS in Mice Plasma and Brain</h1>

</div>


<pre class="r"><code>library(readxl)
library(tidyverse)
library(rebus)
library(broom)
library(Laurae)
library(RColorBrewer)
library(viridis)
library(gridExtra)
library(cowplot)
library(scales)
library(plotly)
library(ComplexHeatmap)
library(circlize)</code></pre>
<pre class="r"><code># General display setting
annot.size = 2 # annotation size
ln.width = .8 # regression line width</code></pre>
<div id="esi-optimization" class="section level1">
<h1><span class="header-section-number">1</span> ESI Optimization</h1>
<pre class="r"><code>path = &quot;/Users/Boyuan/Desktop/My publication/6th. RK metabolites/internal Review files/datasets.xlsx&quot;
CCD.df = read_excel(path, sheet = &quot;ESI CCD&quot;)

CCD.df = CCD.df %&gt;% 
  select(-c(Name, `Data File`, `Acq. Date-Time`, `std order`, `run order`, A.actual, B.actual)) %&gt;%
  mutate(AA = A^2, BB = B^2, AB = A*B) %&gt;%  
  gather(-c(A, B, AB, AA, BB), key = compound, value = response)</code></pre>
<div id="quadratic-regression" class="section level2">
<h2><span class="header-section-number">1.1</span> Quadratic regression</h2>
<pre class="r"><code># 1) clean up
CCD.nested.df = CCD.df %&gt;% nest(-compound) %&gt;%
  mutate(model = map(data, ~lm(response ~ A + B + AB + AA + BB, data = .)), 
         glanced = map(model, glance), tidied = map(model, tidy))

# 2) Model overal stats (later will be used to associate modelling R2 with compound degradation study)
CCD.model.stats.df = CCD.nested.df %&gt;% unnest(glanced) %&gt;% 
  select(compound, r.squared, adj.r.squared, p.value)  %&gt;% arrange(r.squared)

cmpd.ordered.CCD = CCD.model.stats.df$compound %&gt;% 
  factor(levels = CCD.model.stats.df$compound, ordered = T) # compound ordered by R2
CCD.model.stats.df$compound  = CCD.model.stats.df$compound %&gt;% 
  factor(levels = cmpd.ordered.CCD, ordered = T)

# 3) Regression coefficients
CCD.model.coefficient.df = CCD.nested.df %&gt;% unnest(tidied) %&gt;% 
  select(-c(std.error, statistic)) %&gt;% 
  mutate(compound = factor(compound, cmpd.ordered.CCD, ordered = T))

# 4) Plot model P values
plt.CCD.model.p = CCD.model.coefficient.df %&gt;% filter(term != &quot;(Intercept)&quot;) %&gt;%
  ggplot(aes(x = compound, y = log10(p.value), color = term)) + 
  geom_text(aes(label = term), fontface = &quot;bold&quot;, size = 4) +
  annotate(geom = &quot;segment&quot;, x = 1, xend = 26, y = log10(0.05), yend = log10(0.05), 
           color = &quot;black&quot;, linetype = &quot;dashed&quot;) + # critical p = 0.05 level
  coord_flip() + scale_y_continuous(breaks = seq(-6, 0, 1)) + 
  scale_color_brewer(palette = &quot;Dark2&quot;) + theme_bw() +
  theme(panel.grid = element_blank(), 
        axis.text = element_text(color = &quot;black&quot;, size = 12), legend.position = &quot;None&quot;)

# 5) Plot model R2
plt.CCD.model.R2 = CCD.model.stats.df %&gt;% 
  gather(c(r.squared, adj.r.squared), key = R2.Types, value = R2.value) %&gt;%
  ggplot(aes(x = compound, y = R2.value, fill = R2.Types)) + 
  geom_bar(stat = &quot;identity&quot;, position = position_dodge(.5)) +
  annotate(geom = &quot;segment&quot;, x = 1, xend = 26, y = .5, yend = .5, 
           linetype = &quot;dashed&quot;, size = .25, color = &quot;black&quot;) +
  coord_flip() + theme_classic() +
  theme(axis.line = element_line(size = .2), axis.text.y = element_blank(), axis.title.y = element_blank(),
        axis.text.x = element_text(color = &quot;black&quot;, size = 12), legend.position = &quot;None&quot;)</code></pre>
<pre class="r"><code># 6) Combine P-value and R2 plots
plt.CCD.model = plot_grid(plt.CCD.model.p, plt.CCD.model.R2, align = &quot;h&quot;, rel_widths = c(1, .4))
plt.CCD.model</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-5-1.png" width="1344" /></p>
</div>
<div id="countour-plot" class="section level2">
<h2><span class="header-section-number">1.2</span> Countour plot</h2>
<pre class="r"><code># 1) Clean up coefficents
x = CCD.model.coefficient.df %&gt;% select(-p.value) %&gt;% 
  spread(key = term, value = estimate)


# 2) Set up standard codes for A and B with small increment step
rep.unit = seq(-1.5, 1.5, 0.1) # level increment steps
unit.length = length(rep.unit) # increment step numbers
A.codedLevel= rep(rep.unit, each = unit.length) # hoding one level the same while changing the other level
B.codedLevel = rep(rep.unit, times = unit.length) # hoding one level the same while changing the other level
y = cbind(A.codedLevel, B.codedLevel) %&gt;% as.tibble()


# 3) Combine regression coefficents with small incremented level codes
contour.steps.df = c()
for (a in cmpd.ordered.CCD) {
  y$compound = a
  contour.steps.df = rbind(contour.steps.df, y)
}
contour.steps.df = contour.steps.df %&gt;% left_join(x, by = &quot;compound&quot;) # join steps with coefficients


# 4) Compute fitted response
contour.steps.df = contour.steps.df %&gt;%
  mutate(fitted.resp = A * A.codedLevel + B * B.codedLevel + 
           AB * A.codedLevel * B.codedLevel + 
           AA * A.codedLevel^2 + BB * B.codedLevel^2 + `(Intercept)`) %&gt;%
  group_by(compound) %&gt;% 
  mutate(percent = fitted.resp / max(fitted.resp)) %&gt;% 
  left_join(CCD.model.stats.df %&gt;% select(compound, r.squared), by = &quot;compound&quot;)  %&gt;% # join R2
  ungroup() %&gt;% mutate(compound = factor(compound, levels = cmpd.ordered.CCD, ordered =  T))


# 5) Contour plot
plt.contour = contour.steps.df %&gt;% 
  mutate(compound = factor(compound, levels = rev(cmpd.ordered.CCD), ordered = T)) %&gt;% 
  filter(r.squared &gt; .75) %&gt;%
  
  ggplot(aes(A.codedLevel, B.codedLevel, z = percent)) +
  geom_tile(aes(fill = percent)) + scale_fill_viridis(option = &quot;A&quot;)  + 
  stat_contour(color = &quot;white&quot;, size = 0.2) +
  facet_wrap(~ compound, nrow = 4) + coord_fixed() + theme_bw() +
  theme(strip.text = element_text(color = &quot;black&quot;, face = &quot;bold&quot;), 
        strip.background = element_blank(), panel.border = element_blank(),
        axis.text = element_text(color = &quot;black&quot;, size = 12), 
        axis.title = element_text(face = &quot;bold&quot;)) +
  labs(x = (&quot;Temperature (A)  (°C)&quot;) , y = &quot;Flow rate (B) (L/min)&quot;) +
  scale_x_continuous(labels = function(x) x * 50 + 200) +   
  scale_y_continuous(labels = function(x) x * 2 + 10)
plt.contour # R2 &gt; 0.75</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-6-1.png" width="960" /></p>
</div>
<div id="model-checking" class="section level2">
<h2><span class="header-section-number">1.3</span> Model checking</h2>
<div id="residual-calculation" class="section level3">
<h3><span class="header-section-number">1.3.1</span> Residual calculation</h3>
<pre class="r"><code># 1) Compute residual at experimented standard levels, and normalize
CCD.residual.df = CCD.model.coefficient.df %&gt;% 
  select(-p.value) %&gt;% spread(key = term, value = estimate) %&gt;%
  left_join(  CCD.df %&gt;% rename(A.codedLevel = A, B.codedLevel = B) %&gt;% 
                select(A.codedLevel, B.codedLevel, compound, response), by = &quot;compound&quot;  ) %&gt;%
  mutate(fitted = A * A.codedLevel + B * B.codedLevel + 
           AB * A.codedLevel * B.codedLevel + 
           AA * A.codedLevel^2 + BB * B.codedLevel^2 + `(Intercept)`,
         resid = response - fitted) %&gt;%
  group_by(compound) %&gt;% # normalize in to Z-score
  mutate(resp.Zscore = (response - mean(response))/sd(response), 
         fitted.Zscore = (fitted - mean(fitted))/sd(fitted), 
         resid.Zscore = (resid - mean(resid))/sd(resid)) %&gt;%
  ungroup() %&gt;% mutate(compound = factor(compound, levels = cmpd.ordered.CCD, ordered = T))
CCD.residual.df</code></pre>
</div>
<div id="residual-vs.fitted" class="section level3">
<h3><span class="header-section-number">1.3.2</span> Residual vs. fitted</h3>
<pre class="r"><code>CCD.residual.df %&gt;% ggplot(aes(x = fitted.Zscore, y = resid.Zscore)) + 
  geom_point() + facet_wrap(~compound) + 
  geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;Firebrick&quot;) +
  labs(x = &quot;Fitted value (transformed into Z-score)&quot;, 
       y = &quot;Residual (transformed into Z-score&quot;)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-8-1.png" width="1152" /></p>
<pre class="r"><code># Little correlation of residual vs. fitted value.</code></pre>
</div>
<div id="shapiro-wilks-normality-test" class="section level3">
<h3><span class="header-section-number">1.3.3</span> Shapiro-Wilk’s normality test</h3>
<pre class="r"><code>CCD.shapiro.df = CCD.residual.df %&gt;% group_by(compound) %&gt;% 
  mutate(shapiro.p.value = shapiro.test(resid.Zscore)[[2]]) %&gt;%
  summarise(shapiro.p.value = unique(shapiro.p.value)) %&gt;% 
  arrange(shapiro.p.value) %&gt;% 
  mutate(compound = as.character(compound))
CCD.shapiro.df$compound = CCD.shapiro.df$compound %&gt;% 
  factor(levels = CCD.shapiro.df$compound, ordered = T)

CCD.shapiro.df %&gt;% ggplot(aes(x = compound, y = shapiro.p.value)) + 
  geom_bar(stat = &quot;identity&quot;) + coord_flip() +
  annotate(geom = &quot;segment&quot;, x = 1, xend = 26, y = .05, yend = .05, 
           color = &quot;white&quot;, size = 1, linetype = &quot;dashed&quot;) + 
  scale_y_continuous(breaks = seq(0, 1, .2)) +
  geom_text(aes(label = paste0(round(shapiro.p.value, 2)), x = compound), 
            hjust = 1.1, color = &quot;white&quot;, fontface = &quot;bold&quot;, size = 2.5, parse = T) +
  theme(axis.text = element_text(size = 8)) +
  labs(x = &quot;p value of Shapiro-Wilk normality test&quot;)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-9-1.png" width="1152" /></p>
<pre class="r"><code># Modelling generally agreed well with normality assumption.</code></pre>
<pre class="r"><code># 2-3) fitted VS. actual
CCD.residual.df = CCD.residual.df %&gt;% left_join(CCD.model.stats.df, by = &quot;compound&quot;)
CCD.residual.df$compound = CCD.residual.df$compound %&gt;% 
  factor(levels = cmpd.ordered.CCD %&gt;% rev(), ordered = T ) # reverse the display order
CCD.residual.df$center.pt = 
  ifelse((CCD.residual.df$A.codedLevel==0) &amp; (CCD.residual.df$B.codedLevel == 0), &quot;yes.center&quot;, &quot;nope&quot;)

plt.CCD.fitted.vs.Actual = CCD.residual.df %&gt;% 
  ggplot(aes(x = resp.Zscore, y = fitted.Zscore, color = center.pt)) +
  geom_point(shape = 1) + facet_wrap(~compound, nrow = 4) +
  annotate(geom = &quot;segment&quot;, x = -2, xend = 2, y= -2, yend = 2, 
           color = &quot;black&quot;, size = .3, linetype = &quot;dashed&quot;) +
  theme_bw() + scale_color_brewer(palette = &quot;Set1&quot;) +  coord_equal() +
  theme(strip.text = element_text(face = &quot;bold&quot;, size = 7), 
        strip.background = element_blank(), panel.grid = element_blank(), 
        axis.text = element_text(color = &quot;black&quot;),
        axis.title = element_text(face = &quot;bold&quot;)) +
  labs(x = &quot;Actual response (transfromed to Z-score)&quot;, 
       y = &quot;Fitted response (transformed to Z-score)&quot;) +
  geom_text(aes(label = r.squared %&gt;% round(2)), 
            x = 1.3, y = -1.7, size = 2, color = &quot;black&quot;, alpha = 0.7)
plt.CCD.fitted.vs.Actual</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-10-1.png" width="1152" /></p>
</div>
</div>
</div>
<div id="validation-experiment" class="section level1">
<h1><span class="header-section-number">2</span> Validation Experiment</h1>
<div id="data-tidy-up" class="section level2">
<h2><span class="header-section-number">2.1</span> Data tidy up</h2>
<pre class="r"><code># Import compound code data set for later use
cmpd.code = read_excel(path, sheet = &quot;compound code&quot;)</code></pre>
<pre class="r"><code># Import and clean up datasets of peak area RATIO (analyte vs. internal standard; for spiked sample) and dataset of calibration ----
ratio.df = read_excel(path = path, sheet = &quot;response vs IS ratio_B.Y.&quot;)
ratio.df = ratio.df %&gt;% select(-c(`Data File`, `Acq. Date-Time`)) %&gt;% 
  gather(-c(Name, Tissue, Level), key = compound, value = ratio) %&gt;% # dataset clean up
  mutate(Tissue = factor(Tissue, levels = c(&quot;Pl&quot;, &quot;Br&quot;), ordered = T)) # convert tissue to &quot;factor&quot; type

cal.df = read_excel(path = path, sheet = &quot;calibration&quot;) # import calibration data file

# combine signal response dataset (ratio.df) and calibration dataset (cal.df)
ratio.cal.df = left_join(ratio.df, cal.df, by = &quot;compound&quot;) </code></pre>
<div id="calibration" class="section level3">
<h3><span class="header-section-number">2.1.1</span> Calibration</h3>
<pre class="r"><code># Compute concentration (ng/mL) using two sets of calibration: low &amp; high. (y axis being peak area RATIO of analyte vs. internal standard) 

#1) compute concentration
x1 = ratio.cal.df %&gt;% filter(ratio &lt; cutpoint.ratio) %&gt;% 
  mutate(conc.ng.mL = (ratio - low.intercept)/low.slope * IS.conc.ng.mL )
x2 = ratio.cal.df %&gt;% filter(ratio &gt;= cutpoint.ratio) %&gt;% 
  mutate(conc.ng.mL = (ratio - high.intercept)/high.slope * IS.conc.ng.mL )
conc.df = rbind(x1, x2) %&gt;% select(Name, Tissue, Level, compound, conc.ng.mL)


#2) Examine negative concentrations (negativity caused by calibration error at extremely low levels), and correct to zero
cat(&quot;The total number of negative values is&quot;, (conc.df$conc.ng.mL&lt;0) %&gt;% sum(),
    &quot;, accounting for&quot;, (((conc.df$conc.ng.mL&lt;0) %&gt;% sum())/nrow(conc.df) * 100) %&gt;% round(2), &quot;% of all data&quot;)</code></pre>
<pre><code>## The total number of negative values is 91 , accounting for 3.8 % of all data</code></pre>
<pre class="r"><code># check negativity distribution, all reasonabaly in the blank and enzyme samples
(conc.df[conc.df$conc.ng.mL&lt;0,  c(&quot;Tissue&quot;, &quot;Level&quot;)]) %&gt;% table() </code></pre>
<pre><code>##       Level
## Tissue Blank Enz
##     Pl     9  18
##     Br    27  37</code></pre>
<pre class="r"><code>for (i in 1: nrow(conc.df)){
  if (conc.df$conc.ng.mL[i]&lt;0) {conc.df$conc.ng.mL[i] = 0} # correct all negative values to zeros
}


#3) Compute average &amp; standard deviation of the concentration in Enz, blank &amp; spiked (A.B.C.D) samples
conc.stats.df = conc.df %&gt;% group_by(Tissue, compound, Level) %&gt;%
  summarise(conc.mean = mean(conc.ng.mL), conc.var.simple = var(conc.ng.mL), conc.std.simple = sd(conc.ng.mL))
conc.stats.df</code></pre>
<pre><code>## # A tibble: 312 x 6
## # Groups:   Tissue, compound [52]
##    Tissue compound Level conc.mean conc.var.simple conc.std.simple
##    &lt;ord&gt;  &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;           &lt;dbl&gt;           &lt;dbl&gt;
##  1 Pl     3-HBA    A       1714.         12161.            110.   
##  2 Pl     3-HBA    B        807.          2817.             53.1  
##  3 Pl     3-HBA    Blank      7.63           0.174           0.417
##  4 Pl     3-HBA    C        148.            33.2             5.76 
##  5 Pl     3-HBA    D         21.3            2.44            1.56 
##  6 Pl     3-HBA    Enz        7.08           1.33            1.15 
##  7 Pl     3-HPAA   A       1793.         14774.            122.   
##  8 Pl     3-HPAA   B        847.          5211.             72.2  
##  9 Pl     3-HPAA   Blank     60.6            2.17            1.47 
## 10 Pl     3-HPAA   C        205.           116.             10.8  
## # … with 302 more rows</code></pre>
</div>
</div>
<div id="accuracy-precision-with-random-effects-anova" class="section level2">
<h2><span class="header-section-number">2.2</span> Accuracy &amp; precision with random effects ANOVA</h2>
<div id="random-effects-anova-preliminary" class="section level3">
<h3><span class="header-section-number">2.2.1</span> Random effects ANOVA (preliminary)</h3>
<pre class="r"><code># Compute random factor statistics-based variance for spiked samples at A-B-C-D levels ----
#1) clean up
conc.ABCD.df = conc.df %&gt;% filter(Level %in% c(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;))
conc.ABCD.df = conc.ABCD.df %&gt;% 
  mutate(smpl.ID = conc.ABCD.df$Name %&gt;% str_extract(pattern = DIGIT) %&gt;% as.factor()) # set up sample ID (1-5)


#2) calculate the &quot;means&quot;
conc.ABCD.df = conc.ABCD.df %&gt;% group_by(Tissue, Level, compound, smpl.ID) %&gt;% 
  mutate(conc.smpl.mean = mean(conc.ng.mL)) %&gt;% # two injections averaged for each single sample
  # all injections/sampls averaged for each spiking level
  group_by(Tissue, Level, compound) %&gt;% mutate(conc.grandmean = mean(conc.ng.mL)) 


#3) calculate sum of squares error (SS)
conc.ABCD.df = conc.ABCD.df %&gt;% 
  mutate(conc.SSE = (conc.ng.mL - conc.smpl.mean)^2, 
         conc.SStrt = (conc.smpl.mean - conc.grandmean)^2, 
         conc.SST = (conc.ng.mL - conc.grandmean)^2)
conc.ABCD.stats.df = conc.ABCD.df %&gt;% group_by(Tissue, Level, compound) %&gt;% 
  summarise(conc.SSE = sum(conc.SSE), conc.SStrt = sum(conc.SStrt), conc.SST = sum(conc.SST))

if (((conc.ABCD.stats.df$conc.SSE + conc.ABCD.stats.df$conc.SStrt - conc.ABCD.stats.df$conc.SST ) %&gt;% 
     sum() %&gt;% round(8)) == 0) {
  print(&quot;Computation is CORRECT !!&quot;) } else {
    stop(&quot;Computation is WRONG!!&quot;)} # making sure calculation so far went okay</code></pre>
<pre><code>## [1] &quot;Computation is CORRECT !!&quot;</code></pre>
<pre class="r"><code>#4) calculate mean square &amp; variance &amp; standard deviation
conc.ABCD.stats.df = conc.ABCD.stats.df %&gt;% 
  mutate(df.error = (2-1)*5, df.trt = 5-1, 
         conc.MSE = conc.SSE/df.error, conc.MStrt = conc.SStrt/df.trt, # MSE
         # variance using random factor effects (Ref.page 118)
         conc.var.inj = conc.MSE, conc.var.smpl = (conc.MStrt - conc.MSE)/2) 


#5) Check the negative variances (typical of the method of analysis of variance for random factor statistics)
conc.ABCD.stats.df[(conc.ABCD.stats.df$conc.var.smpl &lt; 0), ] # display the negative observations</code></pre>
<pre><code>## # A tibble: 5 x 12
## # Groups:   Tissue, Level [3]
##   Tissue Level compound conc.SSE conc.SStrt conc.SST df.error df.trt
##   &lt;ord&gt;  &lt;chr&gt; &lt;chr&gt;       &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;
## 1 Pl     B     3-HPPA    6697.     1157.     7854.          5      4
## 2 Pl     D     ROH          3.48      2.75      6.23        5      4
## 3 Br     D     3,4-DHPE     1.31      0.759     2.07        5      4
## 4 Br     D     4-HBOH       2.14      0.721     2.86        5      4
## 5 Br     D     VLiAce       8.80      3.36     12.2         5      4
## # … with 4 more variables: conc.MSE &lt;dbl&gt;, conc.MStrt &lt;dbl&gt;,
## #   conc.var.inj &lt;dbl&gt;, conc.var.smpl &lt;dbl&gt;</code></pre>
<pre class="r"><code>for (i in 1:nrow(conc.ABCD.stats.df)) {
  # consider the negativity suggesting insignificant contribution from sample variance
  if (conc.ABCD.stats.df$conc.var.smpl[i] &lt; 0) { conc.ABCD.stats.df$conc.var.smpl[i] = 0 }  
}


#6) After abovementioned correction to zero for negative variance, calculate total variance and related standard deviation
conc.ABCD.stats.df = conc.ABCD.stats.df %&gt;%
  mutate(conc.var.total = conc.var.inj + conc.var.smpl, 
         conc.std.total = sqrt(conc.var.total), # total variance/standard deviation
         conc.var.inj.pct = conc.var.inj/conc.var.total*100, 
         conc.var.smpl.pct = conc.var.smpl/conc.var.total*100) # variance percentage</code></pre>
<pre class="r"><code># Visualize the partition of variance, injection VS. QC sample ----
#1) Stacked bar plot for variance partition
plt.ANOVA.variance.partition = conc.ABCD.stats.df %&gt;% 
  select(Tissue, Level, compound, conc.var.inj, conc.var.smpl) %&gt;%
  gather(c(conc.var.inj, conc.var.smpl), key = source, value = variance) %&gt;%
  ggplot(aes(x = compound, y = variance, fill = source)) + 
  geom_bar(stat = &quot;identity&quot;, position = position_fill(), alpha = .9) +
  coord_flip() + facet_grid(Tissue ~ Level) + 
  labs(y = &quot;Contribution percent of different source of variance&quot;) +
  theme_bw() + theme(axis.text = element_text(color = &quot;black&quot;), 
                     strip.text = element_text(face = &quot;bold&quot;), strip.background = element_blank(),
                     panel.grid = element_blank())
plt.ANOVA.variance.partition</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-15-1.png" width="1152" /></p>
<pre class="r"><code># save a copy of this dataset for later re-plot of variance partition with rearranged order of compound
conc.ABCD.stats.df.laterUse = conc.ABCD.stats.df 


#2-1) Contribution percent distribution; histogram
conc.ABCD.stats.df %&gt;% ggplot(aes(x = conc.var.smpl.pct)) + 
  geom_histogram(binwidth = 5) + facet_grid(Tissue ~ Level) +
  labs(x = &quot;sample-derived variability&quot;) + 
  scale_x_continuous(breaks = seq(0, 100, 20)) + theme_bw() # sample associated variance</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" width="960" /></p>
<pre class="r"><code>conc.ABCD.stats.df %&gt;% ggplot(aes(x = conc.var.inj.pct)) + 
  geom_histogram(binwidth = 5) + facet_grid(Tissue ~ Level) +
  labs(x = &quot;injection-derived variability&quot;) + 
  scale_x_continuous(breaks = seq(0, 100, 20)) + theme_bw() # injection associated variance</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-16-2.png" width="960" /></p>
<pre class="r"><code>#2-2) Contribution percent distribution; density plot
p1 = conc.ABCD.stats.df %&gt;%
  ggplot(aes(x = conc.var.smpl.pct, fill = Level, color = Level)) + 
  geom_density(alpha = 0.1) + facet_wrap(~ Tissue, nrow = 1) +
  labs(x = &quot;sample-derived variability&quot;) + 
  scale_x_continuous(breaks = seq(0, 100, 10)) + theme_bw()  # sample associated variance

p2 = conc.ABCD.stats.df %&gt;% 
  ggplot(aes(x = conc.var.inj.pct, fill = Level, color = Level)) + 
  geom_density(alpha = 0.1) + facet_wrap(~ Tissue, nrow = 1) +
  labs(x = &quot;injection-derived variability&quot;) + 
  scale_x_continuous(breaks = seq(0, 100, 10)) + theme_bw()  # injection associated variance
grid.arrange(p1, p2, nrow = 2) # p1 and p2 only temporary objects, may overwritten later</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-16-3.png" width="960" /></p>
</div>
<div id="repeatability-preliminary" class="section level3">
<h3><span class="header-section-number">2.2.2</span> Repeatability (preliminary)</h3>
<pre class="r"><code># Combine average concentration with random factor statistics-based variance for REPETABILITY 
# 1) Calculation
Repeatability.df = conc.ABCD.stats.df %&gt;%  
  select(Tissue, Level, compound, conc.var.inj) %&gt;%
  mutate(conc.std.inj = sqrt(conc.var.inj)) %&gt;%
  right_join(conc.stats.df %&gt;% 
               select(Tissue, Level, compound, conc.mean) %&gt;% 
               filter(Level %in% c(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;)), by = c(&quot;Tissue&quot;, &quot;compound&quot;, &quot;Level&quot;)) %&gt;%
  mutate(`Repeatability(%)` = conc.std.inj / conc.mean * 100)


# 2) Visualization (Will re-do later after calculation of accuracy, and re-arrange order of compounds by order of averaged accuracy)
Repeatability.df %&gt;% ggplot(aes(x = compound, y = `Repeatability(%)`, color = Level))  + 
  geom_point() + facet_wrap(~Tissue) + coord_flip()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-17-1.png" width="1152" /></p>
<pre class="r"><code>### Combine average concentration with random factor statistics-based variance for Other purposes
conc.stats.df = conc.ABCD.stats.df %&gt;%
  # Augment &quot;conc.stats.df&quot; with random statistics variance
  select(Tissue, Level, compound, conc.var.total, conc.std.total) %&gt;% 
  # Note that &quot;blank&quot; and &quot;Enz&quot; samples have NO random factor statistics-derived variance!
  right_join(conc.stats.df, by = c(&quot;Tissue&quot;, &quot;compound&quot;, &quot;Level&quot;))  </code></pre>
</div>
<div id="random-effects-anova-continued-analysis" class="section level3">
<h3><span class="header-section-number">2.2.3</span> Random effects ANOVA (continued analysis)</h3>
<pre class="r"><code># compare and visualize simple std VS. random-factor variance ----
# plot 1 Scatter plot
# remove &quot;Enz&quot; and &quot;Blank&quot; samples, which do NOT have random factor variance
conc.stats.df %&gt;% filter(Level %in% c(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;)) %&gt;% 
  ggplot(aes(x = conc.std.total, y = conc.std.simple, color = Level)) + 
  geom_point(size = .5, position = position_jitter(10)) + coord_equal() +
  labs(x = &quot;Random factor ANOVA-derived standard deviation of spiked conc. (ng/mL)&quot;, 
       y = &quot;Simple standard deviation of spiked conc.(ng/mL)&quot;) +
  scale_x_continuous(breaks = seq(0, 1200, 100)) + 
  scale_y_continuous(breaks = seq(0, 1200, 100)) + theme_bw()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-19-1.png" width="1152" /></p>
<pre class="r"><code># plot 2 Show difference percentage; bar plot
conc.stats.df %&gt;% 
  # show difference percent: (random - simple)/simple (%)
  mutate(var.diff.rand.VS.simple = (conc.std.total - conc.std.simple)/conc.std.simple * 100) %&gt;% 
  filter(Level %in% c(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;)) %&gt;% # remove &quot;Enz&quot; and &quot;Blank&quot;, as above
  ggplot(aes(x = compound, y = var.diff.rand.VS.simple)) + geom_bar(stat = &quot;identity&quot;) + 
  coord_flip() + facet_grid(Tissue ~ Level)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-20-1.png" width="1152" /></p>
<pre class="r"><code># plot 3 Show difference distribution; histogram
conc.stats.df %&gt;% 
  # show difference percent: (random - simple)/simple (%)
  mutate(var.diff.rand.VS.simple = (conc.std.total - conc.std.simple)/conc.std.simple * 100) %&gt;% 
  filter(Level %in% c(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;)) %&gt;%
  ggplot(aes(x = var.diff.rand.VS.simple, fill = Level)) + 
  geom_histogram(binwidth = .5) + scale_x_continuous(breaks = seq(0, 25, 5)) +
  labs(x = &quot;Percent point difference of random effects-derived std higher than simple std&quot;) + 
  theme_bw() + facet_wrap(~Tissue) +
  theme(panel.grid = element_blank(), strip.background = element_blank())</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-21-1.png" width="960" /></p>
<pre class="r"><code># plot 4 Show observations (rows) with large difference (&gt; 10 %)
conc.stats.df %&gt;% 
  mutate(var.diff.rand.VS.simple = (conc.std.total - conc.std.simple)/conc.std.simple * 100) %&gt;%
  filter(var.diff.rand.VS.simple &gt; 10)  </code></pre>
<pre><code>## # A tibble: 3 x 9
## # Groups:   Tissue, Level [2]
##   Tissue Level compound conc.var.total conc.std.total conc.mean
##   &lt;ord&gt;  &lt;chr&gt; &lt;chr&gt;             &lt;dbl&gt;          &lt;dbl&gt;     &lt;dbl&gt;
## 1 Pl     B     3-HPPA         1339.            36.6      689.  
## 2 Br     D     4-HBOH            0.429          0.655      2.81
## 3 Br     D     VLiAce            1.76           1.33      16.2 
## # … with 3 more variables: conc.var.simple &lt;dbl&gt;, conc.std.simple &lt;dbl&gt;,
## #   var.diff.rand.VS.simple &lt;dbl&gt;</code></pre>
<pre class="r"><code># When the difference is bigger than 10% of simple variance, the sample variance is negligible; most variance from injection !!</code></pre>
</div>
<div id="accuracy" class="section level3">
<h3><span class="header-section-number">2.2.4</span> Accuracy</h3>
<pre class="r"><code># 1) Clean up &quot;conc.stats.df&quot;
blank.df = conc.stats.df %&gt;% ungroup %&gt;% 
  filter(Level == &quot;Blank&quot;) %&gt;% 
  select(-c(Level, conc.var.total, conc.std.total)) %&gt;% # Notice the ungroup function
  rename(blank.mean = conc.mean, blank.var = conc.var.simple, blank.std = conc.std.simple)

Enz.df = conc.stats.df %&gt;% ungroup %&gt;% 
  filter(Level == &quot;Enz&quot;) %&gt;% select(-c(Level, conc.var.total, conc.std.total)) %&gt;%
  rename(Enz.mean = conc.mean, Enz.var = conc.var.simple, Enz.std = conc.std.simple)

conc.ABCD.stats.df = conc.stats.df %&gt;% 
  filter(Level %in% c(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;)) %&gt;% 
  select(-c(conc.var.simple, conc.std.simple)) %&gt;%
  rename(spk.measure.mean = conc.mean, spk.measure.var = conc.var.total, spk.measure.std = conc.std.total) %&gt;%
  select(Tissue, Level, compound, spk.measure.mean, spk.measure.var, spk.measure.std)

Accuracy.df = conc.ABCD.stats.df %&gt;%
  left_join(blank.df, by = c(&quot;Tissue&quot;, &quot;compound&quot;)) %&gt;% select(-ends_with(&quot;std&quot;))


# 2) Combine with expected spike amount
# import spike level data set
spk.df = read_excel(path = path, sheet = &quot;spike.stock.solution(ug.mL-1)&quot;)  
# The imported conc. being the stock conc. of A,B, C, D. 10 ul spiked into plasma (final reconsitution volume (FRV) 100 ul) and 20 ul spiked into brain (FRV 200 ul)
spk.df = spk.df %&gt;% gather(-compound, key = Level, value = `conc.stock`) %&gt;% 
  mutate(spk.true = conc.stock/10*1000 ) %&gt;% select(-conc.stock)
# &quot;spk.true&quot;, the expected/spiked concentration in the HPLC vial before injection
# combine meausred data set with actual spike amoung data set
Accuracy.df = Accuracy.df %&gt;% left_join(spk.df, by = c(&quot;compound&quot;, &quot;Level&quot;))


# 3) Calculate accuracy mean and variability
Accuracy.df = Accuracy.df %&gt;% 
  mutate(`Accuracy.mean(%)` = (spk.measure.mean - blank.mean)/spk.true * 100,
         `Accuracy.std (%)`= 1/spk.true * sqrt(spk.measure.var + blank.var) * 100)


# 4) Rearrange compound order according to the average level of accuracy in both tissues and all spike levels (except D)
x = Accuracy.df %&gt;% filter(Level != &quot;D&quot;) %&gt;% group_by(compound) %&gt;% 
  summarise(AC.TissueLevelMean = mean(`Accuracy.mean(%)`)) %&gt;% arrange(AC.TissueLevelMean)
cmpd.ordered = factor(x$compound, ordered = T)
Accuracy.df = Accuracy.df %&gt;% mutate(compound = factor(compound, levels = cmpd.ordered))


# 5) Plot accuracy
dotsize  = 2
dodge = 0.3
plt.Accuracy = Accuracy.df %&gt;%
  ggplot(aes(x = compound, y = `Accuracy.mean(%)`, color = Level)) +
  
  geom_errorbar(aes(ymin = `Accuracy.mean(%)` - `Accuracy.std (%)`, ymax = `Accuracy.mean(%)` + `Accuracy.std (%)`),
                position = position_dodge(dodge), width = .9, size = .5) + 
  # Errorbar function has to be above rectangle annotation...
  annotate(&quot;rect&quot;, xmin = 1, xmax = 26, ymin = 80, ymax = 120, alpha = .1, fill = &quot;black&quot;) +
  annotate(&quot;segment&quot;, x = 1, xend = 26, y = 100, yend = 100, linetype = &quot;dashed&quot;, size = .4)  +
  geom_point(position = position_dodge(dodge), shape = 21, fill = &quot;white&quot;, size = dotsize) +
  # Notice that two y-label will be plotted if &quot;scales = free&quot; is set
  facet_wrap(~Tissue) + coord_flip(ylim = c(0, 200)) + 
  theme_bw()  + scale_color_manual(values = c(&quot;black&quot;, &quot;firebrick&quot;, &quot;steelblue&quot;, &quot;light salmon&quot;)) +
  theme(axis.text = element_text(color =&quot;black&quot;)) +
  theme(strip.text = element_text(face = &quot;bold&quot;), strip.background = element_blank(), 
        panel.grid = element_blank(), axis.title = element_text(face = &quot;bold&quot;)) + labs(y = &quot;Accuracy (%)&quot;)
plt.Accuracy</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-22-1.png" width="1152" /></p>
</div>
<div id="inference-across-linear-range" class="section level3">
<h3><span class="header-section-number">2.2.5</span> Inference across linear range</h3>
<p>Inference of accuracy and random ANOVA across entire calibration range.</p>
<pre class="r"><code>#### Accuracy inference throughout entire LDR ----
Accuracy.LDR.df = Accuracy.df %&gt;% ungroup() %&gt;%
  select(Tissue, Level, compound, `Accuracy.mean(%)`, `Accuracy.std (%)`)

# 1) Remove extreme levels due to blank inteference
x1 = Accuracy.LDR.df %&gt;% 
  # introduced from Enzyme
  filter(((compound %in% c(&quot;4-HPAA&quot;, &quot;4-HBA&quot;, &quot;3-HPAA&quot;))  &amp;  (Level == &quot;D&quot;)))  
x2 = Accuracy.LDR.df %&gt;% 
  # only endogenous in brain
  filter( ((compound %in% c(&quot;3,4-DHPAA&quot;, &quot;HVA&quot;)) &amp; (Level == &quot;D&quot;) &amp; (Tissue == &quot;Br&quot;)  ) )   
x3 = Accuracy.LDR.df %&gt;% 
  # peculiar outlier
  filter( ((compound %in% c(&quot;CA&quot;, &quot;3,4-DHPhLiAce&quot;, &quot;3,4-DHPPA&quot;, &quot;3,4-DHPAA&quot;, &quot;3,4-DHPE&quot;)) &amp; 
             (Tissue == &quot;Pl&quot;) &amp; (Level == &quot;D&quot;)) ) 
D.label.df = rbind(x1, x2, x3) # collection of removed D levels

# remaining after removal of crazy D levels
Accuracy.LDR.df = Accuracy.LDR.df %&gt;% 
  anti_join(D.label.df, by = c(&quot;Tissue&quot;,&quot;compound&quot;, &quot;Level&quot; )) 


# 2) Mark removed rows
x = D.label.df %&gt;% select(Tissue, Level, compound) %&gt;% mutate(removeD = &quot;*&quot;) %&gt;% select(-Level)
Accuracy.LDR.df = Accuracy.LDR.df %&gt;% left_join(x, by = c(&quot;compound&quot;, &quot;Tissue&quot;))


# 3) Calculate MSE (associated with QC replicates)
MSE.LDR.df = Accuracy.LDR.df %&gt;%
  mutate(`Accuracy.var(%)` = `Accuracy.std (%)`^2) %&gt;% group_by(Tissue, compound) %&gt;%
  summarise(MSE = mean(`Accuracy.var(%)`), removeD = unique(removeD))


# 4) calculate MSlevel (associated with spike concentration levels)
MS.level.LDR.df = Accuracy.LDR.df %&gt;% group_by(Tissue, compound) %&gt;% 
  mutate(SS.level = 5 * (`Accuracy.mean(%)` - mean(`Accuracy.mean(%)`))^2  ) %&gt;%
  summarise(SS.level = sum(SS.level), level.no = n_distinct(Level)) %&gt;% 
  mutate(MS.level = SS.level / (level.no - 1))


# 5) Calculate total variance
Accuracy.LDR.var.df = MSE.LDR.df %&gt;% 
  left_join(MS.level.LDR.df, by = c(&quot;compound&quot;, &quot;Tissue&quot;)) %&gt;% 
  mutate(var.level = (MS.level - MSE)/5 ) %&gt;%
  # negative adjusted to zero (insignificant level difference)
  mutate(var.level = ifelse(var.level &gt; 0, var.level, 0)) %&gt;% 
  mutate(var.total = MSE + var.level, std.total = sqrt(var.total))

# 6) Calculate the average accuracy and combine data
Accuracy.LDR.df = Accuracy.LDR.df %&gt;% group_by(Tissue, compound) %&gt;% 
  summarise(`Accuracy.LDR` = mean(`Accuracy.mean(%)`)) %&gt;%
  left_join(Accuracy.LDR.var.df, by = c(&quot;Tissue&quot;, &quot;compound&quot;))


# 7) Visualize
# 7-1 )
plt.LDR1 = Accuracy.LDR.df %&gt;% ggplot(aes(x = compound, y = Accuracy.LDR)) +
  # geom_bar(stat = &quot;identity&quot;, alpha = .8) +
  geom_errorbar(aes(ymin = Accuracy.LDR - std.total, ymax = Accuracy.LDR + std.total), width = .25) +
  geom_point(shape = 21, fill = &quot;white&quot;, size = 2) +
  coord_flip() + facet_wrap(~ Tissue, nrow = 1) +
  
  annotate(geom = &quot;segment&quot;, x = 1, xend = 26, y = 100, yend = 100, 
           color = &quot;firebrick&quot;, linetype = &quot;dashed&quot;) + 
  theme_bw() + theme(strip.text = element_text(face = &quot;bold&quot;), strip.background = element_blank(),
                     panel.grid = element_blank(), axis.text = element_text(color = &quot;black&quot;)) +
  # marking removed rows, vjust to align up with y-axis label
  geom_text(aes(label = removeD, x = compound), y = 5, color = &quot;steelblue&quot;, vjust = .8) + 
  annotate(geom = &quot;rect&quot;, xmin = 1, xmax = 26, ymin = 80, ymax = 120, fill = &quot;black&quot;, alpha = .08)
plt.LDR1 # removed rows has no stars; those removed rows have A-B-C-D four levels included in referrence</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<pre class="r"><code># 7-2)
plt.LDR2 = Accuracy.LDR.df %&gt;% select(Tissue, compound, MSE, var.level) %&gt;% 
  gather(c(MSE, var.level), key = source, value = value) %&gt;%
  ggplot(aes(x = compound, y = value, fill = source)) + 
  geom_bar(stat = &quot;identity&quot;, position = position_fill(), alpha = .8) +
  coord_flip() + facet_wrap(~Tissue) + theme_minimal() + 
  theme(axis.text = element_text(color = &quot;black&quot;), panel.grid = element_blank()) +
  scale_fill_brewer(palette = &quot;Set1&quot;)
plt.LDR2</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-23-2.png" width="672" /></p>
<pre class="r"><code># plot_grid(plt.LDR1, plt.LDR2, nrow = 1, align = &quot;h&quot;, rel_widths = c(1, 0.8))</code></pre>
</div>
<div id="background-interference" class="section level3">
<h3><span class="header-section-number">2.2.6</span> Background interference</h3>
<p>Check metabolites occurrence in the blank (control) sample and enzymetic solution. Blank conent = Endogenous content in the control tissue + Exogenous content in the enzyme solution</p>
<pre class="r"><code># 1) Clean up
blank.Enz.df = conc.stats.df %&gt;% filter(Level %in% c(&quot;Blank&quot;, &quot;Enz&quot;)) %&gt;%
  select(-c(conc.var.total, conc.std.total, conc.var.simple)) %&gt;% 
  mutate(compound = factor(compound, levels = cmpd.ordered, ordered = T))


# 2) Plot Blank vs. Enz
plt.blank.Enz = blank.Enz.df %&gt;%
  ggplot(aes(x = compound, y = conc.mean, fill = Level, color = Level)) +
  geom_bar(stat = &quot;identity&quot;, position = position_dodge(), 
           alpha = 0.6, color = &quot;NA&quot;, width = .8) +
  geom_errorbar(aes(x = compound, 
                    ymin = conc.mean - conc.std.simple, 
                    ymax = conc.mean + conc.std.simple), 
                width = .6, position = position_dodge(1)) +
  coord_flip() +
  annotate(geom = &quot;segment&quot;, x = 1, xend = 26, y = 1, yend = 1, linetype = &quot;dashed&quot;) +
  facet_wrap( ~ Tissue) + theme_bw() +
  theme(strip.text = element_text(face = &quot;bold&quot;), strip.background = element_blank(), 
        panel.grid = element_blank(), axis.text = element_text(color = &quot;black&quot;))
plt.blank.Enz</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-24-1.png" width="1152" /></p>
<pre class="r"><code>blank.Enz.df %&gt;% filter(Tissue == &quot;Br&quot;, compound %in% c(&quot;HVA&quot;, &quot;3,4-DHPAA&quot;)) # manual check</code></pre>
<pre><code>## # A tibble: 4 x 5
## # Groups:   Tissue, Level [2]
##   Tissue Level compound  conc.mean conc.std.simple
##   &lt;ord&gt;  &lt;chr&gt; &lt;ord&gt;         &lt;dbl&gt;           &lt;dbl&gt;
## 1 Br     Blank 3,4-DHPAA   138.              3.84 
## 2 Br     Enz   3,4-DHPAA     0.504           0.230
## 3 Br     Blank HVA         294.              4.35 
## 4 Br     Enz   HVA           0               0</code></pre>
<pre class="r"><code># 3) Compare accuracy vs. endogenous level
ggdraw() + draw_plot(plt.Accuracy, x = 0, y = 0, width = 0.6) + 
  draw_plot(plt.blank.Enz, x = 0.6, width = 0.4)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-24-2.png" width="1152" /></p>
<pre class="r"><code># 4) Correlate accuracy variance with blank level
Accuracy.blank.df = Accuracy.df  %&gt;% 
  # remove zero blanks before log10 transformation
  filter(blank.mean &gt; 0) %&gt;% 
  nest(-c(Tissue, Level)) %&gt;% 
  mutate(model = map(data, ~lm(log10(`Accuracy.std (%)`) ~ log10(blank.mean), data = .)), 
         glanced = map(model, glance)) %&gt;%
  unnest(glanced) %&gt;% unnest(data) %&gt;% 
  # set up regression analysis
  select(-c(adj.r.squared, sigma, statistic, df, logLik, AIC, BIC, deviance, df.residual)) %&gt;% 
  mutate(r.squared = round(r.squared, 3), p.value = scientific(p.value, 2)) 
# Note here that it is the logarithmically transformed data that is correlated!


# 4-1) Construct regression: version 1, more faceted
plt.Accuracy.blank.regression_ver1 = Accuracy.blank.df %&gt;%
  ggplot(aes(x = log10(blank.mean), 
             y = log10(`Accuracy.std (%)`), 
             color = compound)) + # plot main body
  geom_text(aes(label = compound), size = 2.5) +  
  facet_grid(Tissue ~ Level) + theme_bw()  + 
  theme(strip.text = element_text(face = &quot;bold&quot;), 
        strip.background = element_blank(), panel.grid = element_blank(),
        axis.text = element_text(color = &quot;black&quot;), legend.position = &quot;None&quot;) +
  scale_color_manual(values = colorRampPalette(brewer.pal(8, &quot;Dark2&quot;))(26))  +
  
  # regression and statistics
  geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;black&quot;, size = .3) + 
  geom_text(aes(x = -.6, y = 2.6, label = str_c(&quot;R2 = &quot;, r.squared, &quot;\np = &quot;, p.value)), 
            size = 3, color = &quot;black&quot;, fontface = 0, hjust = 0)
plt.Accuracy.blank.regression_ver1</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-24-3.png" width="1152" /></p>
<pre class="r"><code># 4-2) Construct regression: version 2, overlapped
plt.Accuracy.blank.regression_ver2 = Accuracy.blank.df %&gt;% 
  left_join(cmpd.code, by = &quot;compound&quot;) %&gt;%
  
  ggplot(aes(x = blank.mean, y = `Accuracy.std (%)`, color = Level)) + 
  geom_text(aes(label = compound), size = 2.2, alpha = 0.9) +
  scale_x_log10(breaks = c( 0.1, 1, 10, 100, 500)) + 
  scale_y_log10(breaks = c(1, 5, 10, 50, 100, 500, 1000)) + 
  annotation_logticks() + facet_wrap(~Tissue) + 
  scale_color_manual(values = c(&quot;#008B8B&quot;, &quot;#6B8E23&quot;, &quot;orangered&quot;, &quot;black&quot;)) +
  theme_bw()  + theme(strip.text = element_text(face = &quot;bold&quot;), 
                      strip.background = element_blank(), panel.grid = element_blank(),
                      axis.text = element_text(color = &quot;black&quot;, size = 11.5), 
                      axis.title = element_text(face = &quot;bold&quot;)) +
  labs(x = &quot;Log10 (Blank concentration (ng/mL))&quot;,
       y = &quot;Log10 (Accuracy standard deviation (%))&quot;) +
  
  # regression and statistics
  geom_smooth(method = &quot;lm&quot;, se = F, size = .8) + 
  geom_text(aes(x = 1, y = 200, label =  r.squared), size = 2, 
            fontface = 0, hjust = 0, position = position_dodge(1.5)) +
  geom_text(aes(x = 1, y = 150, label =  p.value), size = 2,
            fontface = 0, hjust = 0, position = position_dodge(2))
plt.Accuracy.blank.regression_ver2</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-25-1.png" width="1152" /></p>
</div>
<div id="random-effects-anova-revised" class="section level3">
<h3><span class="header-section-number">2.2.7</span> Random effects ANOVA (revised)</h3>
<pre class="r"><code># 1) data set
x = blank.df %&gt;% select(Tissue, compound, blank.var)
x %&gt;% filter(compound == &quot;HVA&quot;)</code></pre>
<pre><code>## # A tibble: 2 x 3
##   Tissue compound blank.var
##   &lt;ord&gt;  &lt;chr&gt;        &lt;dbl&gt;
## 1 Pl     HVA          0.662
## 2 Br     HVA         18.9</code></pre>
<pre class="r"><code>variance.partition.all.df =
  conc.ABCD.stats.df.laterUse %&gt;% ungroup() %&gt;%
  select(Tissue, Level, compound, conc.var.smpl, conc.var.inj) %&gt;% 
  left_join(x, by = c(&quot;compound&quot;, &quot;Tissue&quot;)) %&gt;%
  # arrange in order to check programming went okay
  arrange(compound, Tissue, Level) %&gt;% 
  gather(-c(Tissue, Level, compound), key = source, value = variance) %&gt;%
  mutate(compound = factor(compound, levels = cmpd.ordered, ordered = T))


# 2-1) visualization - fill chart
plt.ANOVA.variance.partition =
  variance.partition.all.df %&gt;%
  ggplot(aes(x = compound, y = variance, fill = source)) + 
  geom_bar(stat = &quot;identity&quot;, position = &quot;fill&quot;, alpha = .9) +
  coord_flip() + facet_grid(Tissue ~ Level, scales = &quot;free&quot;) +  theme_minimal() +
  theme(axis.text = element_text(color = &quot;black&quot;, size = 7.1), panel.grid  = element_blank()) +
  scale_fill_manual(values = c(&quot;#212624&quot;, &quot;tomato&quot;, &quot;#54678F&quot;)) # black - red - blue
plt.ANOVA.variance.partition</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-26-1.png" width="1152" /></p>
<pre class="r"><code># 2-2) visualization - dodged position
plt.ANOVA.variance.partition.dodge =  variance.partition.all.df %&gt;%
  # filter(Level == &quot;D&quot;) %&gt;%
  ggplot(aes(x = compound, y = variance, fill = source)) + 
  geom_bar(stat = &quot;identity&quot;, position = position_dodge(), alpha = .9) +
  coord_flip() + facet_grid(Tissue ~ Level, scales = &quot;free&quot;) +  
  theme_bw() + theme(legend.position = &quot;bottom&quot;) +
  # coord_flip(ylim = c(0, 10)) +
  theme(axis.text = element_text(color = &quot;black&quot;, size = 7.1), 
        panel.grid  = element_blank(), strip.background = element_blank()) +
  scale_fill_manual(values = c(&quot;#212624&quot;, &quot;tomato&quot;, &quot;#54678F&quot;)) # black - red - blue
plt.ANOVA.variance.partition.dodge</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-26-2.png" width="1152" /></p>
</div>
<div id="repeatability-revised-1" class="section level3">
<h3><span class="header-section-number">2.2.8</span> Repeatability ( revised 1)</h3>
<p>Plot with re-ordered compound by order of averaged accuracy level (ABC).</p>
<pre class="r"><code># 1) Primary plot
plt.Repeatability = Repeatability.df %&gt;%
  mutate(compound = factor(compound, levels = cmpd.ordered, ordered = T)) %&gt;% 
  left_join(cmpd.code, by = &quot;compound&quot;) %&gt;%
  group_by(Tissue) %&gt;% mutate(avg = mean(`Repeatability(%)`)) %&gt;%
  
  ggplot(aes(x = compound, y = `Repeatability(%)`, color = Level))  +
  geom_point(position = position_dodge(dodge), shape = 21, fill = &quot;white&quot;, size = dotsize)  +
  scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, 5)) +
  coord_flip() + facet_wrap(~Tissue) +
  
  theme_bw()  + 
  scale_color_manual(values = c(&quot;black&quot;, &quot;firebrick&quot;, &quot;steelblue&quot;, &quot;light salmon&quot;)) + 
  theme(axis.text = element_text(color =&quot;black&quot;)) +
  theme(strip.text = element_text(face = &quot;bold&quot;), strip.background = element_blank(), 
        panel.grid = element_blank(), axis.title = element_text(face = &quot;bold&quot;)) +
  labs(y = &quot;repeatability (%)&quot;) +
  geom_line(aes(x = cmpd.code, y = avg), linetype = &quot;dashed&quot;, 
            color = &quot;black&quot;, size = .4) # annotate average level
plt.Repeatability</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-27-1.png" width="1152" /></p>
<pre class="r"><code># 2) Summary plot
plt.Repeatability.hist =
  Repeatability.df %&gt;% ggplot(aes(x = `Repeatability(%)`, fill = Level)) + 
  geom_histogram(binwidth = .5) + 
  facet_wrap(~Tissue, nrow = 1) + theme_bw() +
  theme(axis.text = element_text(color =&quot;black&quot;)) +  
  theme(strip.text = element_text(face = &quot;bold&quot;), 
        strip.background = element_blank(), panel.grid = element_blank()) +
  scale_fill_brewer(palette = &quot;Set2&quot;)
plt.Repeatability.hist</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-28-1.png" width="1152" /></p>
</div>
</div>
<div id="matrix-effects-recovery-and-processing-efficiency" class="section level2">
<h2><span class="header-section-number">2.3</span> Matrix effects, recovery and processing efficiency</h2>
<div id="matrix-effect" class="section level3">
<h3><span class="header-section-number">2.3.1</span> Matrix effect</h3>
<pre class="r"><code># 1) Import data set and clean up
area.df = read_excel(path, sheet = &quot;peak area_B.Y.&quot;)
area.df = area.df %&gt;% select(-c(Name, `Acq. Date-Time`)) %&gt;% 
  filter( !(Level %in% c(&quot;A&quot;,&quot;D&quot;))) %&gt;%
  # matrix effect validated on B, C level, not including A and D
  gather(-c(`Data File`, Tissue, Level), key = compound, value = area)  

# 1-1) spike in pure solvent
area.sol.df = area.df %&gt;% filter(Tissue == &quot;Sol&quot;) %&gt;% 
  group_by(Tissue, Level, compound) %&gt;%
  summarise(area.sol.mean = mean(area), area.sol.std = sd(area)) %&gt;% 
  ungroup() %&gt;% select(-Tissue)


# 1-2) post-extraction spike in biomatrix
post.index = area.df$`Data File` %&gt;% str_detect(pattern = or(&quot;Post&quot;, &quot;post&quot;))
area.postBio.df = area.df[post.index,] %&gt;% filter(Tissue != &quot;Sol&quot;) %&gt;%
  group_by(Tissue, Level, compound) %&gt;% 
  summarise(area.postBio.mean = mean(area), area.postBio.std = sd(area))


# 1-3) pre-extraction spike in biomatrix
area.preBio.df = area.df[!post.index, ] %&gt;% filter(Level != &quot;Blank&quot;) %&gt;%
  group_by(Tissue, Level, compound) %&gt;% 
  summarise(area.preBio.mean = mean(area), area.preBio.std = sd(area))


# 1-4) blank
area.blk.df = area.df %&gt;% filter(Level == &quot;Blank&quot;) %&gt;% 
  group_by(Tissue, compound) %&gt;% 
  summarise(area.blk.mean = mean(area), area.blk.std = sd(area))


# 1-5) combine all three types of spike
matrix.df = area.preBio.df %&gt;% 
  left_join(area.postBio.df, by = c(&quot;Tissue&quot;, &quot;Level&quot;, &quot;compound&quot;)) %&gt;% 
  left_join(area.sol.df, by = c(&quot;Level&quot;, &quot;compound&quot;)) %&gt;%
  left_join(area.blk.df, by = c(&quot;Tissue&quot;, &quot;compound&quot;))


# 2) Compute matrix effect, recovery, and processing efficiency
matrix.df = matrix.df %&gt;%
  mutate(`Recovery.mean(%)` = area.preBio.mean / area.postBio.mean * 100,
         `Recovery.std (%)` = `Recovery.mean(%)` * 
           sqrt(  (area.preBio.std/area.preBio.mean)^2 + (area.postBio.std/area.postBio.mean)^2) ,
         
         `Matrix.mean(%)` = (area.postBio.mean - area.blk.mean)/ area.sol.mean * 100,
         `Matrix.std (%)` = `Matrix.mean(%)` *  
           sqrt(  (area.postBio.std^2 + area.blk.std^2)/(area.postBio.mean - area.blk.mean)^2 +
                    (area.sol.std/area.sol.mean)^2  ) ,
         
         `Process.mean (%)` = (area.preBio.mean - area.blk.mean)/area.sol.mean * 100,
         `Process.std (%)`= `Process.mean (%)` * 
           sqrt(  (area.preBio.std^2 + area.blk.std^2)/(area.preBio.mean - area.blk.mean)^2 +  
                    (area.sol.std/area.sol.mean)^2 )
  )

matrix.df = matrix.df %&gt;% ungroup() %&gt;% select(Tissue, Level, compound, contains(&quot;%&quot;))


# 3) matrix.df clean up for visualization
x1 = matrix.df %&gt;% select(-contains(&quot;std&quot;)) %&gt;% 
  gather(contains(&quot;mean&quot;), key = effect, value = mean)
x1$effect = x1$effect %&gt;% str_extract(pattern = one_or_more(WRD))

x2 = matrix.df %&gt;% select(-contains(&quot;mean&quot;)) %&gt;% 
  gather(contains(&quot;std&quot;), key = effect, value = std)
x2$effect = x2$effect %&gt;% str_extract(pattern = one_or_more(WRD))

matrix.tidy.df = x1 %&gt;%
  left_join(x2, by = c(&quot;Tissue&quot;, &quot;Level&quot;, &quot;compound&quot;, &quot;effect&quot;)) %&gt;% 
  mutate(Tissue = factor(Tissue, levels = c(&quot;Pl&quot;,&quot;Br&quot;), ordered = T))


# 4) Visualization
# reaarange compound display order
matrix.tidy.df$compound = matrix.tidy.df$compound %&gt;% factor(levels = cmpd.ordered, ordered = T) 
matrix.tidy.df = matrix.tidy.df %&gt;% group_by(compound, Tissue, Level, effect) %&gt;% 
  mutate(plt.align = sample(1:1000, 1)) # for central dot &amp; error bar alignment


# 4-1) normal scale
plt.matrix = matrix.tidy.df %&gt;% ungroup() %&gt;%
  mutate(effect = str_extract(effect, pattern = WRD)) %&gt;% 
  mutate(effect = factor(effect, levels = c(&quot;R&quot;, &quot;M&quot;, &quot;P&quot;), ordered = T)) %&gt;% # effect display order
  
  ggplot(aes(x = compound, y = mean, color = effect, shape = Level, group = plt.align)) +
  geom_errorbar(aes(ymin = mean - std, ymax = mean + std), 
                position = position_dodge(dodge), width = .9, size = .5) +
  # rectangular...has to be after errorbar
  annotate(&quot;rect&quot;, xmin = 1, xmax = 26, ymin = 80, ymax = 120, alpha = .1, fill = &quot;black&quot;) +
  annotate(&quot;segment&quot;, x = 1, xend = 26, y = 100, yend = 100, linetype = &quot;dashed&quot;, size = .4) +
  geom_point(position = position_dodge(dodge), fill = &quot;white&quot;, size = dotsize) + 
  scale_shape_manual(values = c(15, 22)) +
  
  facet_wrap(~Tissue) + coord_flip(ylim = c(0, 200)) +  
  scale_color_brewer(palette = &quot;Dark2&quot;) + theme_bw() +
  labs(y = &quot;Effects (%)&quot;) +
  theme(strip.text = element_text(face = &quot;bold&quot;), strip.background = element_blank(), 
        panel.grid = element_blank(),
        axis.text = element_text(color = &quot;black&quot;), axis.title = element_text(face = &quot;bold&quot;))
plt.matrix # M, matrix effect; P, processing; R, recovery</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-29-1.png" width="1056" /></p>
<pre class="r"><code># 4-2) log10 scale as miniature inset
plt.matrix.miniature = matrix.tidy.df %&gt;% 
  mutate(mean.log = log10(mean), std.log = log10(std)) %&gt;%
  
  ggplot(aes(x = compound, y = mean.log, color = effect, shape = Level, group = plt.align)) +
  geom_point(position = position_dodge(dodge), fill = &quot;white&quot;) + 
  scale_shape_manual(values = c(15, 22)) +
  annotate(&quot;segment&quot;, x = 1, xend = 26, y = log10(100), yend = log10(100), 
           linetype = &quot;dashed&quot;, size = .4) +
  facet_wrap(~Tissue) + coord_flip() +  scale_color_brewer(palette = &quot;Dark2&quot;) + 
  theme_bw() + theme(strip.text = element_text(face = &quot;bold&quot;), 
                     strip.background = element_blank(), panel.grid = element_blank(), 
                     axis.text = element_text(color = &quot;black&quot;)) +
  labs(title = &quot;logscale&quot;)
plt.matrix.miniature</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-29-2.png" width="1056" /></p>
<pre class="r"><code># 5) density plot of recovery vs. matrix effects
plt.density.matrix.recovery = matrix.df %&gt;% 
  mutate(notes = str_c(compound, &quot;_&quot;, Level)) %&gt;%
  mutate(Tissue = factor(Tissue, levels = c(&quot;Pl&quot;, &quot;Br&quot;), ordered = T)) %&gt;%
  
  ggplot(aes(x = `Recovery.mean(%)`, y = `Matrix.mean(%)`)) + 
  stat_density_2d(aes(fill = stat(density)), geom = &quot;raster&quot;, contour = F) +
  scale_fill_viridis(option = &quot;inferno&quot;) + facet_wrap(~Tissue) + 
  geom_rug(sides = &quot;tr&quot;, color = &quot;steelblue&quot;, alpha = 0.5) +
  scale_x_log10() + scale_y_log10() + annotation_logticks() +
  theme_minimal() + 
  theme(axis.text = element_text(color = &quot;black&quot;), panel.spacing = unit(.5, &quot;cm&quot;)) +
  geom_point(color = &quot;white&quot;, alpha = .3, size = .6, shape = 16)
# geom_text(color = &quot;white&quot;, size = 1, alpha = .5, aes(label = notes))
plt.density.matrix.recovery</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-30-1.png" width="960" /></p>
</div>
<div id="matrix-effect-vs.accuracy" class="section level3">
<h3><span class="header-section-number">2.3.2</span> Matrix effect vs. accuracy</h3>
<p>Check the correlation of matrix effect (average of B &amp; C levels) vs. accuracy (average of A B and C; without D)</p>
<pre class="r"><code># 1) Combine matrix effect data set with accuracy data set
x1= matrix.df %&gt;% group_by(Tissue, compound) %&gt;%
  summarise(matrix.LevelMean = mean(`Matrix.mean(%)`), 
            recovery.LevelMean = mean(`Recovery.mean(%)`),
            Process.LevelMean = mean(`Process.mean (%)`))
x2 = Accuracy.df %&gt;% filter(Level != &quot;D&quot;) %&gt;% group_by(Tissue, compound) %&gt;% 
  summarise(accuracy.LevelMean = mean(`Accuracy.mean(%)`))

Acc.Mat.df = x1 %&gt;% left_join(x2, by = c(&quot;compound&quot;, &quot;Tissue&quot;))

Acc.Mat.tidy.df = Acc.Mat.df %&gt;% 
  gather(c(matrix.LevelMean, recovery.LevelMean, Process.LevelMean), 
         key = effect, value = effect.percent) %&gt;%
  mutate(effect = str_extract(effect, pattern = one_or_more(WRD))) # tidy up


# 2) Compute coorelation and visualize
Acc.Mat.tidy.df %&gt;%
  ggplot(aes(x = effect.percent, y = accuracy.LevelMean, color = effect)) +
  geom_point() + facet_wrap(~ Tissue, nrow = 1, scales = &quot;free&quot;) +
  geom_smooth(method = &quot;lm&quot;, se = F) +
  stat_smooth_func(geom = &quot;text&quot;, parse = T,
                   position = position_jitterdodge(0, .2), method = &quot;lm&quot;, hjust = 0) +
  scale_x_log10() + scale_y_log10(breaks = seq(0, 200, 50)) + 
  annotation_logticks(scaled = T, short = unit(.8, &quot;mm&quot;)) +
  
  theme_bw() +
  theme(strip.text = element_text(face = &quot;bold&quot;), strip.background = element_blank(), 
        panel.grid = element_blank(), axis.text = element_text(color = &quot;black&quot;))</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-31-1.png" width="1152" /></p>
<pre class="r"><code># 3) Manually calculate coorelation for double check &amp; annotation with designted location
plt.Acc.mat = Acc.Mat.tidy.df %&gt;% ungroup() %&gt;% nest(-c(Tissue, effect)) %&gt;%
  mutate(model = map(data, ~ lm(log10(accuracy.LevelMean) ~ log10(effect.percent), data = .)), 
         glanced = map(model, glance)) %&gt;% unnest(glanced) %&gt;%
  
  # Note here that it is the logarithmically transformed data that is correlated!
  # the result is the same as using built-in stat_smooth_func demand!!!
  select(Tissue, effect, r.squared, p.value) %&gt;% 
  mutate(r.squared = round(r.squared, 2), p.value = scientific(p.value, 2)) %&gt;%
  # join original data set (accuracy, matrix....)
  right_join(Acc.Mat.tidy.df, by = c(&quot;Tissue&quot;, &quot;effect&quot;)) %&gt;% 
  left_join(cmpd.code, by = &quot;compound&quot;) %&gt;%
  # Set Pl then Br display order
  mutate(Tissue = factor(Tissue, levels = c(&quot;Pl&quot;, &quot;Br&quot;), ordered = T)) %&gt;% 
  
  ggplot(aes(x = effect.percent, y = accuracy.LevelMean, color = effect)) +
  geom_text(aes(label = compound), size = 1.7, alpha = 0.9, 
            position = position_jitter(0.08, .08)) +
  facet_wrap(~ Tissue, nrow = 1) + 
  scale_x_log10(breaks = c(10, 50, 100, 500)) + 
  scale_y_log10(breaks = c(10, 50, 100, 150, 200)) + 
  annotation_logticks(scaled = T, short = unit(.8, &quot;mm&quot;)) +
  annotate(&quot;segment&quot;, x = 10, xend = 300, y = 10, yend = 300, 
           linetype = &quot;dashed&quot;, size = .4, color =&quot;darkgreen&quot;) + # length limited by above scale breaks
  annotate(&quot;text&quot;,  x = 220, y = 290, label = &quot;y = x&quot;, color = &quot;darkgreen&quot; ) + # annotate y = x
  labs(x = &quot;Log10 (Effects (%))&quot;, y = &quot;Log10 (Accuracy (%))&quot;) +
  
  geom_smooth(method = &quot;lm&quot;, se = F, alpha = 0.7, size = .8) + # add regresson and statistics
  geom_text(aes(x = 220, y = 30, label = r.squared), size = 2, position = position_dodge(.5)) +
  geom_text(aes(x = 220, y = 25, label = p.value), size = 2,position = position_dodge(.8)) +
  
  theme_bw() +  # theme
  theme(strip.text = element_text(face = &quot;bold&quot;), strip.background = element_blank(), 
        panel.grid = element_blank(), axis.text = element_text(color = &quot;black&quot;, size = 11.5), 
        axis.title = element_text(face = &quot;bold&quot;)) +
  scale_color_manual(values = c(&quot;Firebrick&quot;, &quot;Steelblue&quot;, &quot;Black&quot;))
plt.Acc.mat</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-31-2.png" width="1152" /></p>
<pre class="r"><code># 4) plot regression analysis together
# plot_grid(plt.Accuracy.blank.regression_ver2, plt.Acc.mat, align = &quot;v&quot;, nrow = 2) # ~ 1:1 display ratio

# Combine plots together
# ggdraw() +
#   draw_plot(plt.ANOVA.variance.partition,       x =0,    y = 0,   width = 0.5, height = 1) +
#   draw_plot(plt.Accuracy.blank.regression_ver2, x = 0.5, y = 0.5, width = 0.5, height = .5) +
#   draw_plot(plt.Acc.mat,                        x = 0.5, y = 0,   width = 0.5, height = .5)</code></pre>
</div>
<div id="repeatability-revised-2" class="section level3">
<h3><span class="header-section-number">2.3.3</span> Repeatability (revised 2)</h3>
<p>Re-plot repeatability plot with re-ordered compound by order of averaged accuracy level (ABC)</p>
<pre class="r"><code># 1) Primary plot
plt.Repeatability = Repeatability.df %&gt;% 
  mutate(compound = factor(compound, levels = cmpd.ordered, ordered = T)) %&gt;% 
  left_join(cmpd.code, by = &quot;compound&quot;) %&gt;%
  group_by(Tissue) %&gt;% mutate(avg = mean(`Repeatability(%)`)) %&gt;%
  
  ggplot(aes(x = compound, y = `Repeatability(%)`, color = Level))  +
  geom_point(position = position_dodge(dodge), shape = 21, fill = &quot;white&quot;, size = dotsize) +  
  scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, 5)) +
  coord_flip() + facet_wrap(~Tissue) +
  
  theme_bw()  + scale_color_manual(values = c(&quot;black&quot;, &quot;firebrick&quot;, &quot;steelblue&quot;, &quot;light salmon&quot;)) + 
  theme(axis.text = element_text(color =&quot;black&quot;)) +
  theme(strip.text = element_text(face = &quot;bold&quot;), strip.background = element_blank(),
        panel.grid = element_blank(), axis.title = element_text(face = &quot;bold&quot;)) +
  labs(y = &quot;repeatability (%)&quot;) +
  # annotate average level
  geom_line(aes(x = cmpd.code, y = avg), linetype = &quot;dashed&quot;, color = &quot;black&quot;, size = .4) 
plt.Repeatability</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-32-1.png" width="1152" /></p>
<pre class="r"><code># 2) Summary plot
Repeatability.df %&gt;% ggplot(aes(x = `Repeatability(%)`, color = Level, fill = Level)) + 
  geom_histogram(binwidth = 1) + facet_wrap(~Tissue, nrow = 1) +
  theme(axis.text = element_text(color =&quot;black&quot;)) + 
  theme(strip.text = element_text(face = &quot;bold&quot;), 
        strip.background = element_blank(), panel.grid = element_blank())</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-33-1.png" width="1152" /></p>
</div>
<div id="accuracy-repeatabiltiy-plot-matrix-effects" class="section level3">
<h3><span class="header-section-number">2.3.4</span> Accuracy &amp; repeatabiltiy plot &amp; matrix effects</h3>
<pre class="r"><code># 1) standard plot
# the two missing values come from repeatability (removed high repeatability, Check!)
grid.arrange(plt.Accuracy, plt.Repeatability, plt.matrix, nrow = 1)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-34-1.png" width="1344" /></p>
<pre class="r"><code># 2) density plot of averaged accuracy vs. precision
plt.density.accuracy.vs.repeatability = Repeatability.df %&gt;% ungroup() %&gt;% 
  select(Tissue, Level, compound, `Repeatability(%)`) %&gt;%
  left_join(Accuracy.df %&gt;% ungroup() %&gt;% select(Tissue, Level, compound, `Accuracy.mean(%)`), 
            by = c(&quot;compound&quot;, &quot;Tissue&quot;, &quot;Level&quot;)) %&gt;%
  mutate(notes = str_c(compound, &quot;_&quot;, Level)) %&gt;%
  
  
  ggplot(aes(x = `Accuracy.mean(%)`, y = `Repeatability(%)`)) + 
  stat_density_2d(aes(fill = stat(density)), geom = &quot;raster&quot;, contour = F) +
  scale_fill_viridis() + facet_wrap(~Tissue) + 
  geom_rug(sides = &quot;tr&quot;, alpha = 0.5, color = &quot;steelblue&quot;) +
  # geom_text(color = &quot;white&quot;, size = 1, alpha = .5, aes(label = notes)) +
  geom_point(color = &quot;white&quot;, alpha = .3, size = .6, shape = 16) +
  scale_x_log10() + scale_y_log10() + annotation_logticks() + theme_minimal() +
  theme(axis.text = element_text(color = &quot;black&quot;), panel.spacing = unit(.5, &quot;cm&quot;))
plt.density.accuracy.vs.repeatability</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-35-1.png" width="1152" /></p>
</div>
<div id="is-correction-vs.accuracy-vs.processing-efficiency" class="section level3">
<h3><span class="header-section-number">2.3.5</span> IS correction vs. accuracy vs. processing efficiency</h3>
<pre class="r"><code># 1) Dataset clean up
Acc.Process.df = Acc.Mat.tidy.df %&gt;% filter(effect == &quot;Process&quot;) %&gt;% 
  mutate(Process.diff = (effect.percent - 100), 
         Accuracy.diff = (accuracy.LevelMean - 100)) %&gt;%
  select(Tissue, compound, ends_with(&quot;diff&quot;)) %&gt;% 
  gather(ends_with(&quot;diff&quot;), key = source, value = diff) %&gt;%
  mutate(source = str_extract(source, pattern = one_or_more(WRD))) %&gt;% ungroup() %&gt;%
  mutate(compound = factor(compound, levels = cmpd.ordered, ordered = T), 
         Tissue = factor(Tissue, levels = c(&quot;Pl&quot;, &quot;Br&quot;), ordered = T))


# 2) Bar plot
plt.Acc.Proces = Acc.Process.df %&gt;% 
  ggplot(aes(x = compound, y = diff, fill = source)) + 
  geom_bar(stat = &quot;identity&quot;, position = position_dodge(.5)) +
  coord_flip() + facet_wrap(~Tissue) + theme_bw() +
  theme(axis.text = element_text(color = &quot;black&quot;, size = 10),
        strip.text = element_text(face = &quot;bold&quot;), strip.background = element_blank(), 
        panel.grid = element_blank(),
        legend.position = c(.4, .8), 
        axis.title = element_text(face = &quot;bold&quot;, size = 10)) + 
  scale_y_continuous(breaks = seq(-50, 250, 50)) +
  labs(y = &quot;Deviation of accuracy and processing efficiency from one hundred percentage level&quot;,
       x = &quot;Metabolites&quot;)
plt.Acc.Proces</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-36-1.png" width="1152" /></p>
<pre class="r"><code># 3) Regression analysis: IS correction VS Accuracy
Acc.IScorrection.df = Acc.Process.df %&gt;% 
  spread(key = source, value = diff) %&gt;% 
  rename(Accuracy.diff = Accuracy, Process.diff = Process) %&gt;%
  mutate(Accuracy.abs.diff = abs(Accuracy.diff), 
         Process.abs.diff = abs(Process.diff), 
         IS.correction =  Accuracy.abs.diff/Process.abs.diff ) %&gt;%
  select(-c(Accuracy.diff, Process.diff, Process.abs.diff)) %&gt;% 
  left_join(cmpd.code, by = &quot;compound&quot;) %&gt;%
  
  nest(-Tissue) %&gt;%
  # compute regression statistics on log-transformed data
  mutate(model = map(data, ~lm(log10(Accuracy.abs.diff) ~ log10(IS.correction), data = .)), 
         glanced = map(model, glance)) %&gt;% 
  unnest(glanced) %&gt;% unnest(data) %&gt;% 
  # Note again that it&#39;s the log transformed data that is corrlated
  mutate(r.squared = round(r.squared, 4), p.value = scientific(p.value, 3)) 


# 4) Visualization Showing the impact of IS
# 4-1) Faceted plots
plt.Acc.IScorrection =  Acc.IScorrection.df %&gt;%
  ggplot(aes(x = IS.correction, y = Accuracy.abs.diff)) + 
  geom_text(aes(label = compound), size = 1.5) + 
  scale_x_log10() + scale_y_log10() + annotation_logticks() +
  scale_color_brewer(palette = &quot;Set1&quot;) + 
  geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;firebrick&quot;) + facet_wrap(~Tissue) +
  
  # R2 notation. Notice it&#39;s for log transformed regression analysis
  geom_text(aes(label = r.squared, x = .1, y = 50), 
            position = position_dodge(.5), size = 2.5) + 
  # p value notation. Notice it&#39;s for log transformed regression analysis
  geom_text(aes(label = p.value, x = .1, y = 40),
            position = position_dodge(.5), size = 2.5) + 
  
  theme_bw() + theme(axis.text = element_text(color = &quot;black&quot;), 
                     strip.text = element_text(face = &quot;bold&quot;), 
                     strip.background = element_blank(), 
                     panel.grid = element_blank())
plt.Acc.IScorrection # accuracy being the average of ABC level</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-37-1.png" width="960" /></p>
<pre class="r"><code># 4-2) Plasma
plt.Acc.IScorrection.plasma =  Acc.IScorrection.df %&gt;% filter(Tissue == &quot;Pl&quot;) %&gt;%
  
  ggplot(aes(x = IS.correction, y = Accuracy.abs.diff, color = compound)) + 
  geom_text(aes(label = compound), size = 2) +
  scale_x_log10(breaks = c(.5, 1)) + 
  scale_y_log10(breaks = c(5, 10, 50)) + annotation_logticks() +
  geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;black&quot;, size = .5)  + 
  theme_bw() + 
  theme(axis.text = element_text(color = &quot;black&quot;, size =9), strip.text = element_text(face = &quot;bold&quot;), 
        strip.background = element_blank(), panel.grid = element_blank(),
        legend.position = &quot;None&quot;, axis.title = element_text(size = 6)) +  
  scale_color_manual(values = colorRampPalette( brewer.pal(8, &quot;Dark2&quot;))(26)) +
  labs(x = &quot;Log10 (IS correction index)&quot;, 
       y = &quot;Log10(Accuracy deviation from one hundred percentage level)&quot;,
       title = &quot;Plasma&quot;)
plt.Acc.IScorrection.plasma</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>
<pre class="r"><code># 4-3) Brain
plt.Acc.IScorrection.brain =  Acc.IScorrection.df %&gt;% filter(Tissue == &quot;Br&quot;) %&gt;%
  
  ggplot(aes(x = IS.correction, y = Accuracy.abs.diff, color = compound)) + 
  geom_text(aes(label = compound), size = 2) +
  scale_x_log10(breaks = c(.1, .5, 1)) + 
  scale_y_log10(breaks = c(1, 5, 10, 50, 100)) + annotation_logticks() +
  geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;black&quot;, size = .5)  + theme_bw() +
  
  theme(axis.text = element_text(color = &quot;black&quot;, size = 9), 
        strip.text = element_text(face = &quot;bold&quot;),
        strip.background = element_blank(), panel.grid = element_blank(),
        legend.position = &quot;None&quot;, axis.title = element_text(size = 7)) +  
  scale_color_manual(values = colorRampPalette( brewer.pal(8, &quot;Dark2&quot;))(26) ) +
  labs(x = &quot;IS correction index&quot;, 
       y = &quot;Accuracy deviation from \none hundred percentage level&quot;,
       title = &quot;Brain&quot;)
plt.Acc.IScorrection.brain</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-39-1.png" width="672" /></p>
<pre class="r"><code># 5) IS most associated with recovery?
Acc.IScorrection.df %&gt;% select(Tissue, compound, IS.correction, cmpd.code) %&gt;% 
  left_join(Acc.Mat.tidy.df, by = c(&quot;Tissue&quot;, &quot;compound&quot;)) %&gt;%
  ggplot(aes(x = IS.correction, y = effect.percent, color = effect)) + 
  geom_point() + facet_grid(effect~Tissue, scales = &quot;free&quot;) + scale_x_log10() + scale_y_log10()</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-40-1.png" width="768" /></p>
</div>
</div>
<div id="compound-instability" class="section level2">
<h2><span class="header-section-number">2.4</span> Compound instability</h2>
<pre class="r"><code>degrad.df = read_excel(path, sheet = &quot;Degradation&quot;)
# 1) Data normalization, removing the effect of Day and Level
x = degrad.df %&gt;% 
  gather(-c(Name, `Data File`, `Acq. Date-Time`, Day, Level), 
         key = compound, value = area) %&gt;%
  group_by(Day, Level) %&gt;% 
  mutate(min.time = min(`Acq. Date-Time`),
         time.elapse.h = (`Acq. Date-Time` - min.time)/3600)

degrad.df = x %&gt;% filter(time.elapse.h == 0) %&gt;% # 1st injection of each day
  mutate(area.fst.inj = area) %&gt;% select(Day, Level, compound, area.fst.inj) %&gt;% 
  left_join(x, by = c(&quot;Day&quot;, &quot;Level&quot;, &quot;compound&quot;)) %&gt;% ungroup() %&gt;%
  group_by(Day, Level, compound) %&gt;% 
  mutate(`remaining(%)` = area/area.fst.inj * 100) %&gt;%  
  mutate(time.elapse.h = as.numeric(time.elapse.h) %&gt;% round(2))


# 2) Data visualization
degrad.df %&gt;%
  ggplot(aes(x = time.elapse.h, y = `remaining(%)`, color = Day, shape = Level)) +
  geom_point()  + facet_wrap(~compound, nrow = 5) +
  scale_color_brewer(palette = &quot;Set1&quot;)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-41-1.png" width="1152" /></p>
<pre class="r"><code># 3) Remove abberant single data point
# Identify &quot;Day4_B_r1.d&quot; as the apparently abberant single data point
degrad.df %&gt;% filter(compound == &quot;RK&quot;, `remaining(%)` &lt; 10) 
degrad.df = degrad.df %&gt;%  filter(`Data File` != &quot;Day4_B_r1.d&quot;)</code></pre>
<pre class="r"><code># 4) Visualize again
degrad.df %&gt;% 
  ggplot(aes(x = time.elapse.h, y = `remaining(%)`, color = Day, shape = Level)) + 
  geom_point()  + scale_shape_manual(values = c(5, 1, 4)) +
  facet_wrap(~compound, nrow = 4) + scale_color_brewer(palette = &quot;Set1&quot;) +  
  theme_bw() + 
  theme(axis.text = element_text(color = &quot;black&quot;), strip.text = element_text(face = &quot;bold&quot;), 
        strip.background = element_blank(), panel.grid = element_blank())</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-42-1.png" width="1152" /></p>
<pre class="r"><code>degrad.model.df = degrad.df %&gt;% 
  select(compound, time.elapse.h, `remaining(%)`) %&gt;% 
  ungroup() %&gt;% nest(-compound) %&gt;%
  mutate(model = map(data, ~lm(`remaining(%)` ~ time.elapse.h, data = .)), 
         tidied = map(model, tidy), glanced = map(model, glance)) %&gt;%
  unnest(glanced) %&gt;% rename(p.value1 = p.value) %&gt;% select(-statistic) %&gt;%
  unnest(tidied) %&gt;% 
  select(compound, term, p.value1, term, estimate, r.squared) %&gt;%
  mutate(term = str_replace(term, pattern = &quot;time.elapse.h&quot;, replacement = &quot;Slope&quot;))

x1 = degrad.model.df %&gt;% filter(term == &quot;Slope&quot;) %&gt;% 
  rename(p.slope = p.value1, estimate.slope = estimate) %&gt;% select(-c(term, r.squared)) %&gt;%
  mutate(p.slope = p.adjust(p.slope, method = &quot;bonferroni&quot;)) # adjust P value for multiple comparison,

x2 = degrad.model.df %&gt;% filter(term == &quot;(Intercept)&quot;) %&gt;%
  rename(p.intercept = p.value1, estimate.intercept = estimate) %&gt;% select(-term)

degrad.model.df = x1 %&gt;% left_join(x2, by = &quot;compound&quot;)

degrad.df = degrad.df %&gt;% 
  select(-c(`Acq. Date-Time`, area, min.time, area.fst.inj)) %&gt;% 
  left_join(degrad.model.df, by = &quot;compound&quot;) %&gt;%
  mutate(regress = estimate.intercept + estimate.slope * time.elapse.h)


# 6) Arrange compound order by degradation severity
cmpd.ordered.degrad = (degrad.df %&gt;% arrange(estimate.slope))$compound %&gt;% unique()
degrad.df = degrad.df %&gt;% ungroup() %&gt;% 
  mutate(compound = factor(compound, levels = cmpd.ordered.degrad, ordered = T))


# 7) Extract simple dataset for annotation (faster computation)
regress.summary.df = degrad.df %&gt;% filter(time.elapse.h == 0, Day == &quot;Day1&quot;, Level ==&quot;A&quot;)


# 6) Build regresion line in the plot
# 6-1) All plots
plt.degrade.all = degrad.df %&gt;% 
  ggplot(aes(x = time.elapse.h, y = `remaining(%)`, color = Day, shape = Level)) + 
  geom_point()  +
  scale_shape_manual(values = c(5, 1, 4)) +
  facet_wrap(~compound, nrow = 4) + scale_color_brewer(palette = &quot;Set1&quot;) +  
  theme_bw() +
  theme(axis.text = element_text(color = &quot;black&quot;, size = 8), 
        strip.text = element_text(face = &quot;bold&quot;), strip.background = element_blank(),
        panel.grid = element_blank(), axis.title = element_text(face = &quot;bold&quot;)) +
  scale_x_continuous(breaks = seq(0, 3, .5)) + scale_y_continuous(breaks = seq(0, 120, 20)) +
  
  geom_line(aes(y = regress), color = &quot;black&quot;, size = ln.width) + # calculated regression line
  
  geom_text(data = regress.summary.df, aes(
    label = ifelse(r.squared &lt; 0.01, &quot;R^2&lt;0.01&quot;, paste(&quot;R^2 ==&quot;, r.squared %&gt;% round(2) ))),  
    # hjust = 0, starting from left; x, y position should be outside the aesthetic
    x = .1, y = 1, color = &quot;black&quot;, size = annot.size, hjust = 0, parse = T) + 
  geom_text(data = regress.summary.df, 
            aes(label = paste(&quot;p =&quot;, ifelse(p.slope &gt; 0.01, p.slope %&gt;% round(2), scientific(p.slope, digits = 2)))),
            # if parse, then scientific notation would fail
            x = 1.2, y = 1, color = &quot;black&quot;, size = annot.size, hjust = 0) + 
  geom_text(data = regress.summary.df, 
            aes(label =  paste(&quot;y =&quot;, round(estimate.slope,2), &quot;· x +&quot;, round(estimate.intercept,2))) ,
            x = .1, y = 15, color = &quot;black&quot;, size = annot.size, hjust = 0, fontface = &quot;bold&quot;) +
  labs(x = &quot;Time (h)&quot;, y = &quot;Concentration remaining fraction (%)&quot;)
plt.degrade.all</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-43-1.png" width="1152" /></p>
<pre class="r"><code># 6-2) Most unstable compounds
regress.summary.df2 = degrad.df %&gt;% 
  filter(time.elapse.h == 0, Day == &quot;Day1&quot;, Level ==&quot;A&quot;, estimate.slope &lt; -10) # MANUAL INPUT NEEDED!!

plt.degrade.severe = degrad.df %&gt;%
  filter(estimate.slope &lt; -10) %&gt;% # MANUAL INPUT NEEDED!!
  ggplot(aes(x = time.elapse.h, y = `remaining(%)`, color = Day, shape = Level)) + 
  geom_point()  + scale_shape_manual(values = c(5, 1, 4)) +
  facet_wrap(~compound, nrow = 3) + scale_color_brewer(palette = &quot;Set1&quot;) +  theme_bw() +
  theme(axis.text = element_text(color = &quot;black&quot;, size = 8), 
        strip.text = element_text(face = &quot;bold&quot;, size = 8),
        strip.background = element_blank(), panel.grid = element_blank(),
        axis.title = element_text(face = &quot;bold&quot;, size = 9)) +
  scale_x_continuous(breaks = seq(0, 3, .5)) + scale_y_continuous(breaks = seq(0, 100, 25)) +
  
  geom_line(aes(y = regress), color = &quot;black&quot;, size = .5) + # calculated regression line
  
  geom_text(data = regress.summary.df2, 
            aes(label = ifelse(r.squared &lt; 0.01, &quot;R^2&lt;0.01&quot;, 
                               paste(&quot;R^2 ==&quot;, r.squared %&gt;% round(2) ))),  # hjust = 0, starting from left
            x = .1, y = 1, # x, y position should be outside the aesthetic
            color = &quot;black&quot;, size = annot.size, hjust = 0, parse = T) + 
  geom_text(data = regress.summary.df2, 
            # if parse, then scientific notation would fail
            aes(label = paste(&quot;p =&quot;, ifelse(p.slope &gt; 0.01, p.slope %&gt;% round(2), 
                                            scientific(p.slope, digits = 2)))),
            x = 1, y = 1, color = &quot;black&quot;, size = annot.size, hjust = 0) + 
  geom_text(data = regress.summary.df2, 
            aes(label =  paste(&quot;y =&quot;, round(estimate.slope,2), &quot;· x +&quot;, round(estimate.intercept, 2))) ,
            x = .1, y = 15, color = &quot;black&quot;, size = annot.size, hjust = 0, fontface = &quot;bold&quot;) +
  labs(x = &quot;Time (h)&quot;, 
       y = &quot;Concentration remaining fraction (%)&quot;)
plt.degrade.severe</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-44-1.png" width="672" /></p>
<div id="degradation-vs.-recovery-matrix-effects-processing-efficiency" class="section level3">
<h3><span class="header-section-number">2.4.1</span> Degradation vs. (recovery &amp; matrix effects &amp; processing efficiency)</h3>
<p>Plot degradation slope coorelation with varaince associated with processing efficiency (later with DOE modelling)</p>
<pre class="r"><code>degrad.matrix.df = matrix.tidy.df %&gt;% 
  left_join(regress.summary.df %&gt;% select(compound, estimate.slope), by = &quot;compound&quot;) %&gt;% 
  select(-plt.align) %&gt;% ungroup()


# 1) Compute regression stats
degrad.matrix.regress.df = degrad.matrix.df %&gt;% nest(-c(effect, Tissue)) %&gt;%
  mutate(model = map(data, ~ lm(std ~ estimate.slope, data = .)), 
         glanced = map(model, glance)) %&gt;% unnest(glanced) %&gt;% unnest(data)


# 2) Visualization
plt.degrad.matrix.regress = degrad.matrix.regress.df %&gt;% 
  left_join(cmpd.code, by = &quot;compound&quot;) %&gt;%
  
  ggplot(aes(x = estimate.slope, y = log10(std), color = Level)) + 
  geom_text(aes(label = compound), size = 1.4) + facet_grid(effect ~ Tissue) +
  geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;black&quot;, size = .5) + 
  scale_color_brewer(palette = &quot;Dark2&quot;) + theme_bw() +
  theme(axis.text = element_text(color = &quot;black&quot;, size = 8), 
        strip.text = element_text(face = &quot;bold&quot;, size = 8),
        strip.background = element_blank(), panel.grid = element_blank(),
        axis.title = element_text(face = &quot;bold&quot;, size = 9)) +
  labs(y = &quot;Log10 (Effects standard deviation (%))&quot;,
       x = &quot;Degradation slope coefficient&quot;) +
  
  geom_text(aes(label = paste0(&quot;R^2 =&quot;, round(r.squared,4))), 
            x = -5, y = 2, size = annot.size -.5, color = &quot;black&quot;) +
  geom_text(aes(label = paste0(&quot;p  =&quot;, scientific(p.value,4))), 
            x = -5, y = 1.8, size = annot.size - .5, color = &quot;black&quot;)
plt.degrad.matrix.regress</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-45-1.png" width="864" /></p>
<pre class="r"><code># 3) Combine degradation with matrix validation variation
plot_grid(plt.degrade.severe, plt.degrad.matrix.regress, nrow = 1, rel_widths = c(2.5, 2))</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-46-1.png" width="1152" /></p>
<pre class="r"><code># 4) Combine degradation with matrix validation mean level
degrad.matrix.regress.df %&gt;% left_join(cmpd.code, by = &quot;compound&quot;) %&gt;%
  ggplot(aes(x = estimate.slope, y = log10(mean), color = Level)) + 
  geom_text(aes(label = compound)) +
  facet_wrap(~Tissue) +  annotation_logticks(sides = &quot;l&quot;) +
  geom_smooth(method = &quot;lm&quot;, se = F)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-46-2.png" width="1152" /></p>
</div>
<div id="compound-degradation-vs.accuracy" class="section level3">
<h3><span class="header-section-number">2.4.2</span> Compound degradation vs. accuracy</h3>
<pre class="r"><code># 1) set up data set and regression stats
Acc.degrad.df = Accuracy.df %&gt;% filter(Level != &quot;D&quot;)  %&gt;% 
  left_join(degrad.model.df %&gt;% select(compound, estimate.slope), by = &quot;compound&quot;) %&gt;% ungroup()
Acc.degrad.regression.stats = Acc.degrad.df %&gt;% nest(-Tissue) %&gt;%
  mutate(model = map(data, ~lm(`Accuracy.mean(%)` ~ estimate.slope, data = .)),
         glanced = map(model, glance)) %&gt;% unnest(glanced)


# 2) Visualize
Acc.degrad.df %&gt;% ggplot(aes(x = estimate.slope, y = `Accuracy.mean(%)`)) + 
  geom_text(aes(label = compound, color = Level), size = 2.5) +
  facet_wrap(~Tissue) + 
  scale_color_brewer(palette = &quot;Set1&quot;) + 
  geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;black&quot;, size = .6) +
  geom_text(data = Acc.degrad.regression.stats, 
            aes(label = paste(&quot;R^2 ==&quot;, r.squared %&gt;% round(2) ), x = -10, y = 200 ), parse = T) +
  geom_text(data = Acc.degrad.regression.stats, 
            aes(label = paste(&quot;p ==&quot;, p.value %&gt;% scientific(3) ), x = -10, y = 190 ), parse = T) +
  theme_bw() + theme(axis.text = element_text(color = &quot;black&quot;), 
                     strip.background = element_blank(), panel.grid = element_blank())</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-47-1.png" width="960" /></p>
</div>
<div id="degradation-vs.ccd-model" class="section level3">
<h3><span class="header-section-number">2.4.3</span> Degradation vs. CCD model</h3>
<pre class="r"><code># 1) Combination of data set of comound degradation modelling and CCD modelling
degrad.CCD.df = CCD.model.stats.df %&gt;% 
  select(compound, r.squared) %&gt;% 
  rename(CCD.R2 = r.squared) %&gt;%
  left_join(degrad.model.df %&gt;% select(compound, estimate.slope) %&gt;% 
              rename(degrad.slope = estimate.slope), by = &quot;compound&quot;) %&gt;%
  left_join(cmpd.code, by = &quot;compound&quot;)


# 2) Compute regression stats
x = lm(CCD.R2 ~ degrad.slope, data = degrad.CCD.df) %&gt;% summary()
R2 = x$r.squared %&gt;% round(2)
Pvalue = (x$coefficients %&gt;% as.tibble())[[2, 4]]  %&gt;% as.numeric()

# 3) Visualization
plt.degrad.CCD = degrad.CCD.df %&gt;% 
  ggplot(aes(x = degrad.slope, y = CCD.R2, color = compound)) +
  geom_text(aes(label = compound), size = 2.5) +
  scale_color_manual(values = colorRampPalette(brewer.pal(8,&quot;Dark2&quot;)) (26) ) +
  geom_smooth(method = &quot;lm&quot;, se = F, color = &quot;firebrick&quot;, size = ln.width, linetype = &quot;dashed&quot;) +
  annotate(geom = &quot;text&quot;, label = paste(&quot;R^2 ==&quot;, R2), x = -30, y = .9, parse = T, size = 2) +
  # parse &amp; scientific seems incompatible ...
  annotate(geom = &quot;text&quot;, label = paste(&quot;p =&quot;, scientific(Pvalue, 2)), x = -30, y = .8, size = 2) + 
  labs(x = &quot;Degradation slope coefficient&quot;, y = &quot;CCD model R2&quot;) + theme_bw() +
  theme(axis.text = element_text(color = &quot;black&quot;, size = 8.5), panel.grid = element_blank(),
        axis.title = element_text(size = 8.5), legend.position = &quot;None&quot;)
plt.degrad.CCD</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-48-1.png" width="768" /></p>
</div>
<div id="effects-of-neat-solvent-vs.biomatrix" class="section level3">
<h3><span class="header-section-number">2.4.4</span> Effects of neat solvent vs. biomatrix</h3>
<p>Visualize in-biomatrices injection pattern and compound stability.</p>
<pre class="r"><code># 1) Calculate peak area difference error of the 2nd injection relative to the 1st injection of the same sample at each spike level
area.df = read_excel(path, sheet = &quot;peak area_B.Y.&quot;)

x = area.df %&gt;% filter(Level %in% c(&quot;A&quot;,&quot;B&quot;,&quot;C&quot;,&quot;D&quot;)) %&gt;%
  gather(-c(Name, `Data File`, `Acq. Date-Time`, Tissue, Level), 
         key = compound, value = area) %&gt;%
  group_by(compound, Name) %&gt;%
  mutate(time.zero = min(`Acq. Date-Time`), 
         time.elapse = ((`Acq. Date-Time` - time.zero)/3600) %&gt;% as.numeric())

area.df = x %&gt;% filter(time.elapse == 0) %&gt;% 
  ungroup() %&gt;% select(Name, area, compound) %&gt;% rename(area.timeZero = area) %&gt;%
  right_join(x, by = c(&quot;Name&quot;, &quot;compound&quot;)) %&gt;% 
  mutate(error = (area - area.timeZero)/area.timeZero * 100)


# 2) visualize. Note that the second injection is spaced from the 1st injection by 8.5 ~ 10.5 hours
# 2-1) plasma
plt.plasma.degrad = area.df %&gt;% filter(time.elapse != 0, Tissue == &quot;Pl&quot;) %&gt;%
  ggplot(aes(x = time.elapse, y = error, color = Level, shape = Tissue)) +
  geom_point(position = position_jitter(.2, 0), size = 2) + scale_color_brewer(palette = &quot;Dark2&quot;) +
  facet_wrap(~compound, nrow = 7) + theme_bw() + scale_shape_manual(values = c(1, 16)) +
  theme(strip.background = element_blank(), strip.text = element_text(face = &quot;bold&quot;),
        axis.text.y = element_text(color = &quot;black&quot;), panel.grid = element_blank()) +
  labs(y = &quot;2nd injection error percent relative to 1st injection of the same sample, spaced by ~10 hours&quot;,
       title = &quot;Plasma&quot;)

plt.plasma.degrad</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-49-1.png" width="960" /></p>
<pre class="r"><code># 2-2) brain
plt.brain.degrad = area.df %&gt;% filter(time.elapse != 0, Tissue == &quot;Br&quot;) %&gt;%
  ggplot(aes(x = time.elapse, y = error, color = Level, shape = Tissue)) +
  geom_point(position = position_jitter(.2, 0), size = 2) + scale_color_brewer(palette = &quot;Dark2&quot;) +
  facet_wrap(~compound, nrow = 7) + theme_bw() + scale_shape_manual(values = c(1, 16)) +
  theme(strip.background = element_blank(), strip.text = element_text(face = &quot;bold&quot;),
        axis.text.y = element_text(color = &quot;black&quot;), panel.grid = element_blank()) +
  labs(y = &quot;2nd injection error percent relative to 1st injection of the same sample, spaced by ~10 hours&quot;,
       title = &quot;Brain&quot;)

plt.brain.degrad</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-49-2.png" width="960" /></p>
<pre class="r"><code># 2-4) all data combined
plt.2ndInjection.vs.1stinjection.biomatrices = area.df %&gt;% filter(time.elapse != 0) %&gt;%
  mutate(compound = factor(compound, levels = rev(cmpd.ordered), ordered = T)) %&gt;%
  
  ggplot(aes(x = 1, y = error, color = Level, shape = Tissue)) +
  geom_point(position = position_jitter(0.18, 0), size = 2) + 
  scale_color_brewer(palette = &quot;Set1&quot;) +
  scale_shape_manual(values = c(1, 4)) +
  facet_wrap(~compound, nrow = 4) +  theme_bw() +
  theme(strip.background = element_blank(), 
        strip.text = element_text(face = &quot;bold&quot;),
        axis.text.y = element_text(color = &quot;black&quot;), 
        panel.grid = element_blank(), axis.text.x = element_blank()) +
  labs(y = &quot;2nd injection error percent relative to 1st injection of the same sample, spaced by ~10 hours&quot;) +
  scale_y_continuous(limits = c(-20, 20)) +
  annotate(geom = &quot;segment&quot;, x = 0.8, xend = 1.2, y = 0, yend = 0, linetype = &quot;dashed&quot;) +
  geom_rug(alpha = .6)

plt.2ndInjection.vs.1stinjection.biomatrices</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-50-1.png" width="1152" /></p>
<pre class="r"><code># note that the time difference of 2nd vs. 1st injection is for plasma 10.4~10.8 hours, for braom 8.6 ~ 9 hours
# removed 17 outliers


# 2-5) histogram
area.df %&gt;% filter(time.elapse != 0) %&gt;% 
  mutate(compound = factor(compound, levels = rev(cmpd.ordered), ordered = T)) %&gt;%
  ggplot(aes(x = error, color = Level, alpha = Tissue, fill = Tissue)) + geom_histogram() +
  scale_color_brewer(palette = &quot;Set1&quot;) +
  facet_wrap(~compound, nrow = 5) +  theme_bw() +
  theme(strip.background = element_blank(), strip.text = element_text(face = &quot;bold&quot;),
        axis.text.y = element_text(color = &quot;black&quot;), panel.grid = element_blank()) +
  labs(y = &quot;2nd injection error percent relative to 1st injection of the same sample, spaced by ~10 hours&quot;) +
  scale_x_continuous(limits = c(-20, 20))</code></pre>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-50-2.png" width="1152" /></p>
</div>
<div id="degradation-test" class="section level3">
<h3><span class="header-section-number">2.4.5</span> Degradation test</h3>
<p>Another independant test in a preliminary study, comparing the compound stability in neat solvent vs. in plasma (collected as a different biosample lot from the prior validation study)</p>
<pre class="r"><code>degrad.prelim = read_excel(path, sheet = &quot;Degrad_prelim&quot;)
# clean up
degrad.prelim = degrad.prelim %&gt;% 
  gather(-c(Sample.Name, Data.File, Acq.Date.Time, Matrix.type, Spike.conc.ng.mL), 
         key = compound, value = response)

# starting time
degrad.prelim = degrad.prelim %&gt;% group_by(Sample.Name) %&gt;% 
  mutate(time.elapsed = Acq.Date.Time - min(Acq.Date.Time),
         time.elapsed =  (time.elapsed/3600) %&gt;% as.numeric() %&gt;% round(2))

# response relative to the 1st inj response
degrad.prelim = degrad.prelim %&gt;% filter(time.elapsed == 0) %&gt;% ungroup() %&gt;%
  select(Sample.Name, compound, response) %&gt;% 
  rename(response.fst.inj = response) %&gt;%
  right_join(degrad.prelim, by = c(&quot;Sample.Name&quot;, &quot;compound&quot;)) %&gt;% 
  group_by(Sample.Name) %&gt;% mutate(remaining = response / response.fst.inj * 100)


# visualize
degrad.prelim %&gt;%
  mutate(compound = factor(compound, levels = cmpd.ordered.degrad, ordered = T)) %&gt;%
  filter(time.elapsed &lt;= 10 &amp; Spike.conc.ng.mL &lt;= 4000 &amp; Spike.conc.ng.mL &gt;= 50, remaining &lt; 120) %&gt;%
  
  ggplot(aes(x = time.elapsed, y = remaining, color = Matrix.type)) + 
  geom_point(size = 1, shape = 21) +
  facet_wrap(~compound, nrow = 4) + scale_color_brewer(palette = &quot;Set1&quot;) + theme_bw() +
  theme(panel.grid = element_blank(), axis.text = element_text(color = &quot;black&quot;), 
        strip.background = element_blank(), strip.text = element_text(face = &quot;bold&quot;)) +
  geom_smooth(method = &quot;lm&quot;, se = F, size = .8) +
  scale_y_continuous(breaks = seq(0, 100, 25)) +
  scale_x_continuous(breaks = seq(0, 10, 2))</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-51-1.png" width="1152" /></p>
</div>
</div>
<div id="method-merits-correlation-matrix" class="section level2">
<h2><span class="header-section-number">2.5</span> Method merits correlation matrix</h2>
<pre class="r"><code>## Blank level
CM1 =
  Accuracy.df %&gt;% ungroup() %&gt;%
  select(compound, Tissue, blank.mean) %&gt;%
  group_by(compound, Tissue) %&gt;% 
  summarise(mean(blank.mean)) %&gt;% 
  rename(`blank AVG` = `mean(blank.mean)`)


## Accuracy mean, variance and blank level
x = Accuracy.df %&gt;% 
  select(compound, Tissue, Level, `Accuracy.mean(%)`, `Accuracy.std (%)`) %&gt;% ungroup()

x1 = x %&gt;% filter(Level == &quot;A&quot;) %&gt;% 
  rename(`Accuracy AVG (A)` = `Accuracy.mean(%)`, `Accuracy SD (A)` = `Accuracy.std (%)`) %&gt;% 
  select(-Level)
x2 = x %&gt;% filter(Level == &quot;B&quot;) %&gt;% 
  rename(`Accuracy AVG (B)` = `Accuracy.mean(%)`, `Accuracy SD (B)` = `Accuracy.std (%)`) %&gt;% 
  select(-Level)
x3 = x %&gt;% filter(Level == &quot;C&quot;) %&gt;%
  rename(`Accuracy AVG (C)` = `Accuracy.mean(%)`, `Accuracy SD (C)` = `Accuracy.std (%)`) %&gt;% 
  select(-Level)
x4 = x %&gt;% filter(Level == &quot;D&quot;) %&gt;% 
  rename(`Accuracy AVG (D)` = `Accuracy.mean(%)`, `Accuracy SD (D)` = `Accuracy.std (%)`) %&gt;% 
  select(-Level)

my.by = c(&quot;compound&quot;, &quot;Tissue&quot;)

CM2 = x1 %&gt;% left_join(x2, by = my.by) %&gt;% left_join(x3, by = my.by) %&gt;% left_join(x4, by = my.by)


## Matrix effects mean and variance
# ----Recovery
y11 = matrix.df %&gt;% select(Tissue, Level, compound, `Recovery.mean(%)`) %&gt;% 
  filter(Level == &quot;B&quot;) %&gt;% rename(`Recovery AVG (B)` = `Recovery.mean(%)`) %&gt;% select(-Level)
y12 = matrix.df %&gt;% select(Tissue, Level, compound, `Recovery.mean(%)`) %&gt;% 
  filter(Level == &quot;C&quot;) %&gt;% rename(`Recovery AVG (C)` = `Recovery.mean(%)`) %&gt;% select(-Level)

y13 = matrix.df %&gt;% select(Tissue, Level, compound, `Recovery.std (%)`) %&gt;% 
  filter(Level == &quot;B&quot;) %&gt;% rename(`Recovery SD (B)` = `Recovery.std (%)`) %&gt;% select(-Level)
y14 = matrix.df %&gt;% select(Tissue, Level, compound, `Recovery.std (%)`) %&gt;% 
  filter(Level == &quot;C&quot;) %&gt;% rename(`Recovery SD (C)` = `Recovery.std (%)`) %&gt;% select(-Level)

# ----Matrix effects
y21 = matrix.df %&gt;% select(Tissue, Level, compound, `Matrix.mean(%)` ) %&gt;% 
  filter(Level == &quot;B&quot;) %&gt;% rename(`Matrix effects AVG (B)` = `Matrix.mean(%)`) %&gt;% select(-Level)
y22 = matrix.df %&gt;% select(Tissue, Level, compound, `Matrix.mean(%)`)  %&gt;%
  filter(Level == &quot;C&quot;) %&gt;% rename(`Matrix effects AVG (C)` = `Matrix.mean(%)`) %&gt;% select(-Level)

y23 = matrix.df %&gt;% select(Tissue, Level, compound, `Matrix.std (%)`) %&gt;% 
  filter(Level == &quot;B&quot;) %&gt;% rename(`Matrix effects SD (B)` = `Matrix.std (%)`) %&gt;% select(-Level)
y24 = matrix.df %&gt;% select(Tissue, Level, compound, `Matrix.std (%)`) %&gt;% 
  filter(Level == &quot;C&quot;) %&gt;% rename(`Matrix effects SD (C)` = `Matrix.std (%)`) %&gt;% select(-Level)

# ----Processing efficiency
y31 = matrix.df %&gt;% select(Tissue, Level, compound, `Process.mean (%)`) %&gt;% 
  filter(Level == &quot;B&quot;) %&gt;% rename(`Process efficiency AVG (B)` = `Process.mean (%)`) %&gt;% select(-Level)
y32 = matrix.df %&gt;% select(Tissue, Level, compound, `Process.mean (%)`) %&gt;% 
  filter(Level == &quot;C&quot;) %&gt;% rename(`Process efficiency AVG (C)` = `Process.mean (%)`) %&gt;% select(-Level)

y33 = matrix.df %&gt;% select(Tissue, Level, compound, `Process.std (%)`) %&gt;% 
  filter(Level == &quot;B&quot;) %&gt;% rename(`Process efficiency SD (B)` = `Process.std (%)`) %&gt;% select(-Level)
y34 = matrix.df %&gt;% select(Tissue, Level, compound, `Process.std (%)`) %&gt;% 
  filter(Level == &quot;C&quot;) %&gt;% rename(`Process efficiency SD (C)` = `Process.std (%)`) %&gt;% select(-Level)

# ----Combine
CM3 = y11 %&gt;% left_join(y12, by = my.by) %&gt;% left_join(y13, by = my.by) %&gt;%
  left_join(y14, by = my.by) %&gt;% left_join(y21, by = my.by) %&gt;% left_join(y22, by = my.by) %&gt;% 
  left_join(y23, by = my.by) %&gt;% left_join(y24 , by = my.by) %&gt;%
  left_join(y31, by = my.by) %&gt;% left_join(y32, by = my.by) %&gt;% 
  left_join(y33, by = my.by) %&gt;% left_join(y34 , by = my.by)
# CM3 %&gt;% View()


## Accuracy variance split into blank variance, injection variance, and sample variance, with corresponding split ratio
z = variance.partition.all.df %&gt;% spread(key = source, value = variance) %&gt;%
  mutate(total.var = blank.var + conc.var.inj + conc.var.smpl, # total variance
         blank.var.percent = blank.var / total.var, 
         inj.var.percent = conc.var.inj/total.var, 
         smpl.var.percent = conc.var.smpl / total.var) %&gt;% # variance percent
  select(Tissue, Level, compound, ends_with(&quot;var.percent&quot;))

# ---- blank variance  percent
z11 = z %&gt;% select(Tissue, Level, compound, blank.var.percent) %&gt;% 
  filter(Level == &quot;A&quot;) %&gt;% rename(`Blank VAR % (A)` = blank.var.percent) %&gt;% select(-Level)
z12 = z %&gt;% select(Tissue, Level, compound, blank.var.percent) %&gt;% 
  filter(Level == &quot;B&quot;) %&gt;% rename(`Blank VAR % (B)` = blank.var.percent) %&gt;% select(-Level)
z13 = z %&gt;% select(Tissue, Level, compound, blank.var.percent) %&gt;% 
  filter(Level == &quot;C&quot;) %&gt;% rename(`Blank VAR % (C)` = blank.var.percent) %&gt;% select(-Level)
z14 = z %&gt;% select(Tissue, Level, compound, blank.var.percent) %&gt;% 
  filter(Level == &quot;D&quot;) %&gt;% rename(`Blank VAR % (D)` = blank.var.percent) %&gt;% select(-Level)

# ---- injection variance  percent
z21 = z %&gt;% select(Tissue, Level, compound, inj.var.percent) %&gt;% 
  filter(Level == &quot;A&quot;) %&gt;% rename(`Injection VAR % (A)` = inj.var.percent) %&gt;% select(-Level)
z22 = z %&gt;% select(Tissue, Level, compound, inj.var.percent) %&gt;% 
  filter(Level == &quot;B&quot;) %&gt;% rename(`Injection VAR % (B)` = inj.var.percent) %&gt;% select(-Level)
z23 = z %&gt;% select(Tissue, Level, compound, inj.var.percent) %&gt;% 
  filter(Level == &quot;C&quot;) %&gt;% rename(`Injection VAR % (C)` = inj.var.percent) %&gt;% select(-Level)
z24 = z %&gt;% select(Tissue, Level, compound, inj.var.percent) %&gt;% 
  filter(Level == &quot;D&quot;) %&gt;% rename(`Injection VAR % (D)` = inj.var.percent) %&gt;% select(-Level)

# ---- QC sample variance  percent
z31 = z %&gt;% select(Tissue, Level, compound, smpl.var.percent) %&gt;% 
  filter(Level == &quot;A&quot;) %&gt;% rename(`QC sample VAR % (A)` = smpl.var.percent) %&gt;% select(-Level)
z32 = z %&gt;% select(Tissue, Level, compound, smpl.var.percent) %&gt;% 
  filter(Level == &quot;B&quot;) %&gt;% rename(`QC sample VAR % (B)` = smpl.var.percent) %&gt;% select(-Level)
z33 = z %&gt;% select(Tissue, Level, compound, smpl.var.percent) %&gt;% 
  filter(Level == &quot;C&quot;) %&gt;% rename(`QC sample VAR % (C)` = smpl.var.percent) %&gt;% select(-Level)
z34 = z %&gt;% select(Tissue, Level, compound, smpl.var.percent) %&gt;% 
  filter(Level == &quot;D&quot;) %&gt;% rename(`QC sample VAR % (D)` = smpl.var.percent) %&gt;% select(-Level)

CM4 = tibble()

# ----Combine
CM4 = z11 %&gt;% left_join(z12, by = my.by) %&gt;% left_join(z13, by = my.by) %&gt;% 
  left_join(z14, by = my.by) %&gt;% left_join(z21, by = my.by) %&gt;% left_join(z22, by = my.by) %&gt;% 
  left_join(z23, by = my.by) %&gt;% left_join(z24 , by = my.by) %&gt;% left_join(z31, by = my.by) %&gt;%
  left_join(z32, by = my.by) %&gt;% left_join(z33, by = my.by) %&gt;% left_join(z34 , by = my.by)


## Degradation slope
CM5 = degrad.model.df %&gt;% select(compound, estimate.slope) %&gt;% 
  rename(`Degradation slope` = estimate.slope)


## CCD model efficiency
CM6 = CCD.model.stats.df %&gt;% select(compound, r.squared)
CM6 = CCD.residual.df %&gt;% filter(center.pt == &quot;yes.center&quot;) %&gt;% group_by(compound) %&gt;% 
  summarise(center.pt.sd = sd(resp.Zscore)) %&gt;% left_join(CM6, by = &quot;compound&quot;) %&gt;%
  rename(`CCD center points SD` = center.pt.sd, `CCD model R2` = r.squared)


##  ALL TOGETHER
CM = CM1 %&gt;% left_join(CM2, by = my.by) %&gt;% left_join(CM3, by = my.by) %&gt;%
  left_join(CM4, by = my.by) %&gt;% left_join(CM5, by = &quot;compound&quot;) %&gt;% left_join(CM6, by = &quot;compound&quot;)
CM.plasma = CM %&gt;% filter(Tissue == &quot;Pl&quot;)
CM.brain = CM %&gt;% filter(Tissue == &quot;Br&quot;)</code></pre>
<pre class="r"><code>## Heatmap
mycolor = c(colorRampPalette(brewer.pal(11, &quot;RdBu&quot;))(100)) %&gt;% rev()

CM.plasma %&gt;% ungroup() %&gt;% select(-c(compound, Tissue)) %&gt;%
  cor() %&gt;% Heatmap(col = mycolor,
                    heatmap_legend_param = list(
                      color_bar = &quot;continuous&quot;, legend_height = unit(8, &quot;cm&quot;), title = &quot;&quot;),
                    column_title = &quot;Plasma&quot;)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-53-1.png" width="960" /></p>
<pre class="r"><code>CM.brain %&gt;% ungroup() %&gt;% select(-c(compound, Tissue)) %&gt;%
  cor() %&gt;% Heatmap(col = mycolor,
                    heatmap_legend_param = list(
                      color_bar = &quot;continuous&quot;, legend_height = unit(8, &quot;cm&quot;), title = &quot;&quot;),
                    cluster_rows = T, cluster_columns = T,
                    # row_names_gp = gpar(fontsize = 6.5),
                    # column_names_gp = gpar(fontsize = 6.5),
                    column_title = &quot;Brain&quot;)</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-54-1.png" width="960" /></p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
